<!-- docs/index.html v3 (spa fallback enabled) -->
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ADA - AI Driven AbuPet</title>
        <link rel="icon" href="logo-abupet.png" type="image/png">
<link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="./spa-redirect.js"></script>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
        <div class="login-card">
            <img src="logo-abupet.png" alt="ADA Logo" class="login-logo">
            <h1>ADA</h1>
            <p>AI Driven AbuPet</p>
            <p id="loginVersion" class="login-version" style="position:absolute; bottom:10px; right:15px; font-size:11px; color:#fff; margin:0; opacity:0.7;"></p>
            <input type="password" id="passwordInput" placeholder="Password" onkeypress="if(event.key==='Enter')login()">
            <button class="btn btn-primary" onclick="login()" data-testid="login-button">Accedi</button>
            <p id="loginError" class="error" style="display:none;" data-testid="login-error">Password errata</p>
        </div>
    </div>

    <!-- App Container -->
    <div id="appContainer" class="app-container">
        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <img src="logo-abupet.png" alt="ADA" class="sidebar-logo">
                <span class="sidebar-title">ADA</span>
                <button class="sidebar-close" onclick="toggleSidebar()" aria-label="Chiudi menu" data-testid="close-sidebar-button">√ó</button>
            </div>
            
            <nav class="sidebar-nav">
                <!-- Sidebar: Veterinario -->
                <div id="sidebar-vet" class="sidebar-role-section">
                    <div class="nav-section">VISITA</div>
                    <div class="nav-item" data-page="patient">üêæ Dati Pet</div>
                    <div class="nav-item active" data-page="recording">üéôÔ∏è Registrazione</div>
                    <div class="nav-item" data-page="soap">üìã Referto</div>
                    <div class="nav-item" data-page="history">üìÅ Archivio Sanitario <span class="badge" id="historyBadge" data-testid="history-badge">0</span></div>
                    <div class="nav-item" data-page="diary">üìî Profilo Sanitario</div>
                </div>

                <!-- Sidebar: Proprietario -->
                <div id="sidebar-owner" class="sidebar-role-section" style="display:none;">
                    <div class="nav-section">I MIEI AMICI ANIMALI</div>
                    <div class="nav-item" data-page="patient">üêæ Dati Pet</div>
                    <div class="nav-item" data-page="diary">üìî Profilo Sanitario</div>
                    <div class="nav-item" data-page="vitals">üìä Parametri Vitali</div>
                    <div class="nav-item" data-page="medications">üíä Farmaci</div>
                    <div class="nav-item" data-page="history">üìÅ Archivio Sanitario <span class="badge" id="historyBadgeOwner" data-testid="history-badge-owner">0</span></div>
                    <div class="nav-item" data-page="qna">‚ùì Domande & Risposte</div>
                    <div class="nav-item" data-page="photos">üì∑ Foto</div>
                </div>

                <!-- Sidebar: Admin Brand / Super Admin -->
                <div id="sidebar-admin" class="sidebar-role-section" style="display:none;">
                    <div class="nav-section">ADMIN PROMO</div>
                    <div class="nav-item" data-page="admin-dashboard">Dashboard</div>
                    <div class="nav-item" data-page="admin-catalog">Catalogo</div>
                    <div class="nav-item" data-page="admin-campaigns">Campagne</div>
                    <div class="nav-item" data-page="admin-wizard">Importa CSV</div>
                </div>

                <div class="nav-section">SISTEMA</div>
                <div class="nav-item" data-page="settings">‚öôÔ∏è Impostazioni</div>
                <div class="nav-item" onclick="refreshPetsFromServer(true); setSidebarOpen(false);">üîÑ Sincronizza</div>
                <div class="nav-item" id="nav-debug" data-page="debug" style="display:none;">üõ† Debug</div>
                <div class="nav-item" onclick="logout()">üö™ Esci</div>
            </nav>
        </aside>
        <button id="sidebarOverlay" class="sidebar-overlay" type="button" aria-label="Chiudi menu" onclick="setSidebarOpen(false)"></button>

        <!-- Main Content -->
        <main class="main-content">
            <div class="topbar">
                <div class="topbar-left">
                    <button class="hamburger" onclick="toggleSidebar()" data-testid="toggle-sidebar-button">‚ò∞</button>
                </div>
                <div class="topbar-center">
                    <div class="selected-pet-header" data-selected-pet-header></div>
                    <!-- Role toggle moved to Debug page -->
                </div>
                <div class="topbar-right">
                    <img id="clinicLogo" src="logo-anicura.png" alt="Logo clinica" class="topbar-logo" data-testid="clinic-logo">
                </div>
            </div>
            
            <!-- Hidden image for PDF export -->
            <img id="anicuraLogoImg" src="logo-anicura.png" style="display:none;" crossorigin="anonymous">
            
            <!-- Page: Recording -->
            <div id="page-recording" class="page active">
                <div class="page-header">
                    <h2>üéôÔ∏è Registrazione</h2>
                </div>
                <div class="card">
                    <button class="btn btn-secondary" style="margin-bottom:12px;" onclick="resetRecordingAndReport()" data-testid="new-recording-button">üÜï Nuova</button>
                </div>
                
                <div class="card">
                    <div class="record-section">
                        <button id="recordBtn" class="record-btn" onclick="toggleRecording()" data-testid="record-button">üé§</button>
                        <div id="timer" class="timer" data-testid="recording-timer">00:00</div>
                        <div id="visualizer" class="visualizer" data-testid="recording-visualizer"></div>
                        <p id="recordingStatus" class="recording-status" data-testid="recording-status">Premi per registrare</p>
                        <div id="lowVoiceWarning" style="display:none; background:#ff4444; color:#fff; padding:6px 12px; border-radius:6px; margin:6px 0; font-size:13px; text-align:center; transition: opacity 0.3s;" data-testid="low-voice-warning">üîá Volume troppo basso ‚Äî avvicina il microfono</div>

                        <!-- Chunk recording runtime info (visible when chunking is enabled) -->
                        <div id="chunkingRuntime" class="chunking-runtime" style="display:none;" data-testid="chunking-runtime">
                            <div class="chunking-badges">
                                <span id="chunkProfileBadge" class="chip" data-testid="chunk-profile-badge">Profilo: ‚Äî</span>
                                <span id="chunkDurationBadge" class="chip" data-testid="chunk-duration-badge">Chunk: ‚Äî</span>
                                <span id="chunkMimeBadge" class="chip" data-testid="chunk-mime-badge">mimeType: ‚Äî</span>
                                <span id="chunkingOnBadge" class="chip chip-green" data-testid="chunking-on-badge">Chunking ON</span>
                            </div>
                            <div class="chunking-status" data-testid="chunking-status">
                                <div id="chunkTimerLine" class="chunking-line" data-testid="chunk-timer-line">Chunk: 00:00 / 00:00</div>
                                <div id="chunkQueueLine" class="chunking-line" data-testid="chunk-queue-line">In coda: 0 ‚Ä¢ In trascrizione: 0</div>
                                <div id="chunkWarnLine" class="chunking-warn" style="display:none;" data-testid="chunk-warn-line">‚ö†Ô∏è Tra ‚Äîs spezzetto il chunk</div>
                            </div>
                        </div>
                        
                        
                        <div class="record-controls">
                            <button id="btnPause" class="btn btn-secondary" onclick="pauseRecording()" disabled data-testid="pause-recording-button">‚è∏Ô∏è Pausa</button>
                            <button id="btnResume" class="btn btn-secondary" onclick="resumeRecording()" disabled data-testid="resume-recording-button">‚ñ∂Ô∏è Riprendi</button>
                            <button id="btnCancel" class="btn btn-danger" onclick="cancelVisitProcess()" disabled data-testid="cancel-visit-button">‚úñÔ∏è Annulla</button>
                        </div>

                        
                        <div class="upload-section">
                            <p style="margin: 15px 0 10px; color: #666;">oppure</p>
                            <div class="button-row">
                                <button class="btn btn-secondary" onclick="triggerAudioUpload()" data-testid="upload-audio-button">üìÅ Carica audio</button>
                                <button class="btn btn-secondary" onclick="triggerTextUpload()" data-testid="upload-text-button">üìÑ Carica testo</button>
                            </div>

                            <!-- Debug-only test tools -->
                            <input type="file" id="audioFileInput" accept="audio/*,.mp3,.wav,.webm,.ogg,.m4a" style="display:none" onchange="handleAudioUpload(event)">
                            <input type="file" id="textFileInput" accept=".txt,.text" style="display:none" onchange="handleTextUpload(event)">
                            <p style="font-size: 12px; color: #888; margin-top: 5px;">Audio: MP3, WAV, WEBM, OGG, M4A | Testo: TXT</p>

                        </div>
                    </div>
                </div>
                
                <div class="card" id="transcriptionCard" style="display:none;">
                    <h3 id="transcriptionTitle">Testo trascritto</h3>
                    <div class="textarea-wrapper">
                        <textarea id="transcriptionText" placeholder="La trascrizione o il testo caricato appariranno qui..." rows="8"></textarea>
                        <!-- Hidden legacy input (v6.17.x): used by generateSOAPFromPaste() as optional source -->
                        <textarea id="pasteText" style="display:none"></textarea>
                        <button class="expand-btn" onclick="expandTextarea('transcriptionText', 'Trascrizione')" data-testid="expand-transcription-button">‚õ∂</button>
                    </div>
                    <div id="transcriptionReadOnlyNote" class="readonly-note" style="display:none;" data-testid="transcription-readonly-note">
                        üîí Questo testo √® in sola lettura perch√© proviene da una trascrizione audio. Se vuoi correggerlo, modifica un file TXT e ricaricalo con ‚ÄúCarica file testo‚Äù.
                    </div>
                    <div id="generateSoapRow" class="button-row" style="margin-top: 10px; display:none;">
                        <button id="btnGenerateSoap" class="btn btn-primary" onclick="generateSOAP()" data-testid="generate-soap-button">üìã Genera Referto</button>
                    </div>
                    <div id="autoSoapCompleteRow" class="button-row" style="margin-top: 10px; display:none;">
                        <button id="btnOpenSoap" class="btn btn-success" onclick="navigateToPage('soap')" data-testid="open-soap-button">üìã Apri il referto</button>
                    </div>

                </div>
            </div>

            <!-- Page: SOAP -->
            <div id="page-soap" class="page">
                <div class="page-header">
                    <h2>üìã Referto</h2>
                </div>
                <div class="card">
                    <div class="form-group" style="margin-bottom:12px;">
                        <label>Titolo</label>
                        <input type="text" id="templateSelector" list="templateOptions" value="" placeholder="Scegli o digita un titolo..." onchange="onTemplateSelectorInput(this.value)">
                        <datalist id="templateOptions">
                            <option value="Visita Generale">
                            <option value="Pronto Soccorso">
                            <option value="Cardiologia">
                            <option value="Controllo">
                            <option value="Dermatologia">
                            <option value="Medicina interna">
                            <option value="Neurologia">
                            <option value="Oncologia">
                            <option value="Ortopedia">
                            <option value="Pre-Chirurgia">
                            <option value="Vaccinazione">
                        </datalist>
                    </div>

                    <div class="lang-selector" id="soapLangSelector">
                        <button class="lang-btn" data-lang="IT" data-testid="soap-lang-it-button">IT</button>
                        <button class="lang-btn" data-lang="EN" data-testid="soap-lang-en-button">EN</button>
                        <button class="lang-btn" data-lang="DE" data-testid="soap-lang-de-button">DE</button>
                        <button class="lang-btn" data-lang="FR" data-testid="soap-lang-fr-button">FR</button>
                        <button class="lang-btn" data-lang="ES" data-testid="soap-lang-es-button">ES</button>
                    </div>

                    <div class="hide-empty-row">
                        <label class="switch" title="Nasconde campi vuoti e sezioni completamente vuote (solo nella UI)">
                            <input type="checkbox" id="hideEmptyToggle" onchange="setHideEmptyFields(this.checked)">
                            <span class="slider"></span>
                        </label>
                        <span class="hide-empty-label">Nascondi campi non compilati</span>
                    </div>
                    
                    <div class="soap-section soap-s">
                        <div class="soap-label">S</div>
                        <label id="labelSoapS">Soggettivo</label>
                        <div class="textarea-wrapper">
                            <textarea id="soap-s" rows="6" placeholder="Sintomi riferiti dal proprietario..."></textarea>
                            <button class="expand-btn" onclick="expandTextarea('soap-s', 'Soggettivo')" data-testid="expand-soap-s-button">‚õ∂</button>
                        </div>
                    </div>
                    
                    <div class="soap-section soap-o">
                        <div class="soap-label">O</div>
                        <label id="labelSoapO">Oggettivo</label>
                        <div class="textarea-wrapper">
                            <textarea id="soap-o" rows="6" placeholder="Esame obiettivo..."></textarea>
                            <button class="expand-btn" onclick="expandTextarea('soap-o', 'Oggettivo')" data-testid="expand-soap-o-button">‚õ∂</button>
                        </div>
                    </div>
                    
                    <div class="soap-section soap-a">
                        <div class="soap-label">A</div>
                        <label id="labelSoapA">Analisi clinica</label>
                        <div class="textarea-wrapper">
                            <textarea id="soap-a" rows="6" placeholder="Diagnosi/valutazione..."></textarea>
                            <button class="expand-btn" onclick="expandTextarea('soap-a', 'Analisi clinica')" data-testid="expand-soap-a-button">‚õ∂</button>
                        </div>
                    </div>
                    
                    <div class="soap-section soap-p">
                        <div class="soap-label">P</div>
                        <label id="labelSoapP">Piano</label>
                        <div class="textarea-wrapper">
                            <textarea id="soap-p" rows="6" placeholder="Piano terapeutico..."></textarea>
                            <button class="expand-btn" onclick="expandTextarea('soap-p', 'Piano')" data-testid="expand-soap-p-button">‚õ∂</button>
                        </div>
                    </div>

                    <!-- Note interne (non stampate, non visibili al proprietario) -->
                    <div class="soap-internal-notes" id="internalNotesSection">
                        <button class="soap-internal-toggle" onclick="toggleInternalNotes()" data-testid="toggle-internal-notes-button">
                            üìù Note interne (non stampate) <span class="toggle-icon" id="internalNotesToggleIcon">‚ñº</span>
                        </button>
                        <div class="soap-internal-body" id="internalNotesBody">
                            <div class="textarea-wrapper">
                                <textarea id="soap-internal-notes" rows="6" placeholder="Note ad uso interno: informazioni dalla trascrizione non incluse nel referto, appunti, promemoria..."></textarea>
                                <button class="expand-btn" onclick="expandTextarea('soap-internal-notes', 'Note interne')" data-testid="expand-internal-notes-button">‚õ∂</button>
                            </div>
                        </div>
                    </div>

                    <div class="soap-actions">
                        <button id="btnSpeakSOAP" class="btn btn-primary" onclick="speakSOAP()" data-testid="speak-soap-button">üîä Leggi</button>
                        <button class="btn btn-success" onclick="saveSOAP()" data-testid="save-soap-button">üíæ Salva</button>
                        <button class="btn btn-secondary" onclick="exportTXT()" data-testid="export-soap-txt-button">üìÑ TXT</button>
                        <button class="btn btn-secondary" onclick="exportPDF()" data-testid="export-soap-pdf-button">üìë PDF</button>
                        <button id="btnRecordCorrection" class="btn btn-secondary" onclick="startCorrectionRecording()" data-testid="record-correction-button">üé§ Correggi</button>
                        <button id="btnTestSoap" class="btn btn-secondary" onclick="testFillSoap()" style="display:none;">üß™ Test</button>
                    </div>
                    <div class="soap-actions" id="correctionButtonsRow" style="display:none; margin-top:8px;">
                        <div id="correctionButtons" class="correction-buttons">
                            <button class="btn btn-danger" onclick="cancelCorrection()" data-testid="cancel-correction-button">‚ùå Annulla</button>
                            <button class="btn btn-success" onclick="sendCorrection()" data-testid="send-correction-button">‚úÖ Invia correzione</button>
                        </div>
                    </div>

                    <button class="btn btn-primary btn-inline" id="btnGenerateOwnerExplanation" style="margin-top: 10px;" onclick="generateOwnerExplanation()" data-testid="generate-owner-explanation-button">üìñ Spiegami il documento</button>
                    <!-- Promo slot: post_visit (PR 3) -->
                    <div id="soap-promo-container"></div>
                </div>
            </div>

            <!-- Page: SOAP Read-Only (for owner viewing archived reports) -->
            <div id="page-soap-readonly" class="page">
                <div class="page-header">
                    <h2>üìã Referto</h2>
                </div>
                <div class="card" id="soapReadonlyCard">
                    <div id="soapReadonlyContent" class="soap-readonly-content">
                        <p style="color:#888; text-align:center; padding:20px;">Seleziona un referto dall'Archivio Sanitario.</p>
                    </div>
                    <div class="soap-actions" style="margin-top:15px;">
                        <button class="btn btn-primary btn-inline" id="btnExplainFromReadonly" onclick="generateOwnerExplanationFromReadonly()" data-testid="explain-from-readonly-button">üìñ Spiegami il documento</button>
                    </div>
                </div>
            </div>

            <!-- Page: Owner -->
            <div id="page-owner" class="page">
                <div class="page-header">
                    <h2>üìÑ Spiegazione Documento</h2>

                </div>
                <div class="card">
                    <div class="lang-selector" id="ownerLangSelector">
                        <button class="lang-btn" data-lang="IT" data-testid="owner-lang-it-button">IT</button>
                        <button class="lang-btn" data-lang="EN" data-testid="owner-lang-en-button">EN</button>
                        <button class="lang-btn" data-lang="DE" data-testid="owner-lang-de-button">DE</button>
                        <button class="lang-btn" data-lang="FR" data-testid="owner-lang-fr-button">FR</button>
                        <button class="lang-btn" data-lang="ES" data-testid="owner-lang-es-button">ES</button>
                    </div>
                    

                    <div class="textarea-wrapper">
                        <textarea id="ownerExplanation" rows="10" placeholder="Spiegazione per il proprietario..."></textarea>
                        <button class="expand-btn" onclick="expandTextarea('ownerExplanation', 'Spiegazione')" data-testid="expand-owner-explanation-button">‚õ∂</button>
                    </div>
                    
                    <div class="button-row">
                        <button id="btnSpeakOwner" class="btn btn-primary" onclick="speakOwnerExplanation()" data-testid="speak-owner-button">üîä Leggi</button>
                        <button class="btn btn-secondary" onclick="exportOwnerTXT()" data-testid="export-owner-txt-button">üìÑ TXT</button>
                        <button class="btn btn-secondary" onclick="exportOwnerPDF()" data-testid="export-owner-pdf-button">üìë PDF</button>
                    </div>
                    
                    <h3 style="margin-top: 20px;">Glossario</h3>
                    <div id="glossaryContent" class="glossary"></div>
                    
                    <h3 style="margin-top: 20px;">Ti suggerisco io qualche domanda?</h3>
                    <div class="button-row">
                        <button class="btn btn-primary" onclick="generateFAQ()" data-testid="generate-faq-button">üìù Genera Domande</button>
                        <button id="btnSpeakFAQ" class="btn btn-secondary" onclick="speakFAQ()" data-testid="speak-faq-button">üîä Leggi Domande</button>
                    </div>
                    <div id="faqList" class="faq-list"></div>
                    <!-- Promo slot: home_feed (PR 3) -->
                    <div id="owner-promo-container"></div>
                </div>
            </div>

            <!-- Page: Patient -->
            <div id="page-patient" class="page">
                <div class="page-header">
                    <h2>üêæ Dati Pet</h2>

                </div>
                
                <!-- Pet Selector Card -->
                <div class="card pet-selector-card">
                    <div class="form-group" style="margin: 0;">
                        <label>üêæ Seleziona Pet</label>
                        <select id="petSelector" style="width:100%;" onchange="onPetSelectorChange(this)">
                            <option value="">-- Seleziona Pet --</option>
                        </select>
                    </div>
                    <div class="pet-actions" style="display:flex; gap:8px; margin-top:10px; flex-wrap:wrap;">
                        <button id="btnSavePet" class="btn btn-success btn-small" onclick="saveCurrentPet()" title="Salva Pet" disabled data-testid="save-pet-button">üíæ Salva</button>
                        <button class="btn btn-small btn-add-pet" onclick="openAddPetPage()" title="Aggiungi nuovo Pet" data-testid="add-pet-button">‚ûï Aggiungi</button>
                        <button id="btnDeletePet" class="btn btn-danger btn-small" onclick="deleteCurrentPet()" title="Elimina Pet" disabled data-testid="delete-pet-button">üóëÔ∏è Elimina</button>
                    </div>
                </div>
                
                <div id="petFieldsCard" class="card" style="display:none;">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Nome Pet <span class="required">*</span></label>
                            <input type="text" id="petName" placeholder="Nome" required>
                        </div>
                        <div class="form-group">
                            <label>Specie <span class="required">*</span></label>
                            <select id="petSpecies" required>
                                <option value="">Seleziona...</option>
                                <option value="Cane">Cane</option>
                                <option value="Gatto">Gatto</option>
                                <option value="Coniglio">Coniglio</option>
                                <option value="Altro">Altro</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Razza</label>
                            <input type="text" id="petBreed" placeholder="Razza">
                        </div>
                        <div class="form-group">
                            <label>Data di nascita</label>
                            <input type="date" id="petBirthdate">
                        </div>
                        <div class="form-group">
                            <label>Sesso</label>
                            <select id="petSex">
                                <option value="">Seleziona...</option>
                                <option value="Maschio">Maschio</option>
                                <option value="Maschio castrato">Maschio castrato</option>
                                <option value="Femmina">Femmina</option>
                                <option value="Femmina sterilizzata">Femmina sterilizzata</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Microchip</label>
                            <input type="text" id="petMicrochip" placeholder="N¬∞ Microchip">
                        </div>
                        <div class="form-group">
                            <label>Proprietario</label>
                            <input type="text" id="ownerName" placeholder="Nome proprietario">
                        </div>
                        <div class="form-group">
                            <label>Telefono</label>
                            <input type="tel" id="ownerPhone" placeholder="Telefono">
                        </div>
                        <div class="form-group">
                            <label>Data Visita</label>
                            <input type="date" id="visitDate">
                        </div>
                    </div>
                    
                    <!-- Lifestyle Section -->
                    <button class="btn btn-secondary" style="margin-top: 20px; width: 100%;" onclick="toggleLifestyleSection()" data-testid="toggle-lifestyle-section-button">
                        üè† Stile di Vita ‚ñº
                    </button>
                    
                    <div id="lifestyleSection" class="lifestyle-section">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Ambiente</label>
                                <select id="petLifestyle">
                                    <option value="">Seleziona...</option>
                                    <option value="indoor">Indoor</option>
                                    <option value="outdoor">Outdoor</option>
                                    <option value="misto">Misto</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Conviventi</label>
                                <select id="petHousehold" multiple>
                                    <option value="bambini">Bambini</option>
                                    <option value="anziani">Anziani</option>
                                    <option value="altri_cani">Altri cani</option>
                                    <option value="altri_gatti">Altri gatti</option>
                                    <option value="altri_animali">Altri animali</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Livello di attivit√†</label>
                                <select id="petActivityLevel">
                                    <option value="">Seleziona...</option>
                                    <option value="basso">Basso</option>
                                    <option value="medio">Medio</option>
                                    <option value="alto">Alto</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Tipo alimentazione</label>
                                <select id="petDietType">
                                    <option value="">Seleziona...</option>
                                    <option value="secco">Secco</option>
                                    <option value="umido">Umido</option>
                                    <option value="barf">BARF</option>
                                    <option value="misto">Misto</option>
                                    <option value="casalingo">Casalingo</option>
                                </select>
                            </div>
                            <div class="form-group full-width">
                                <label>Preferenze alimentari</label>
                                <input type="text" id="petDietPreferences" placeholder="Es: preferisce pollo, evita pesce...">
                            </div>
                            <div class="form-group full-width">
                                <label>Condizioni note</label>
                                <input type="text" id="petKnownConditions" placeholder="Es: insuff. renale, artrosi, allergie...">
                            </div>
                            <div class="form-group full-width">
                                <label>Farmaci attuali</label>
                                <input type="text" id="petCurrentMeds" placeholder="Farmaci in corso (opzionale)">
                            </div>
                            <div class="form-group full-width">
                                <label>Note comportamentali</label>
                                <input type="text" id="petBehaviorNotes" placeholder="Es: paure, ansia, aggressivit√†...">
                            </div>
                            <div class="form-group">
                                <label>Localit√† (opz.)</label>
                                <input type="text" id="petLocation" placeholder="Es: Milano">
                            </div>
                        </div>
                    </div>
                    <!-- Promo slot: pet_profile (PR 3) -->
                    <div id="patient-promo-container"></div>
                    <!-- Vet flag container (PR 3) -->
                    <div id="patient-vet-flag-container"></div>
                </div>
            </div>

            <!-- Page: Add New Pet -->
            <div id="page-addpet" class="page">
                <div class="page-header">
                    <h2>‚ûï Aggiungi Pet</h2>

                </div>
                
                <div class="card">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Nome Pet <span class="required">*</span></label>
                            <input type="text" id="newPetName" placeholder="Nome" required>
                        </div>
                        <div class="form-group">
                            <label>Specie <span class="required">*</span></label>
                            <select id="newPetSpecies" required>
                                <option value="">Seleziona...</option>
                                <option value="Cane">Cane</option>
                                <option value="Gatto">Gatto</option>
                                <option value="Coniglio">Coniglio</option>
                                <option value="Altro">Altro</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Razza</label>
                            <input type="text" id="newPetBreed" placeholder="Razza">
                        </div>
                        <div class="form-group">
                            <label>Data di nascita</label>
                            <input type="date" id="newPetAge">
                        </div>
                        <div class="form-group">
                            <label>Sesso</label>
                            <select id="newPetSex">
                                <option value="">Seleziona...</option>
                                <option value="Maschio">Maschio</option>
                                <option value="Maschio castrato">Maschio castrato</option>
                                <option value="Femmina">Femmina</option>
                                <option value="Femmina sterilizzata">Femmina sterilizzata</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Microchip</label>
                            <input type="text" id="newPetMicrochip" placeholder="N¬∞ Microchip">
                        </div>
                        <div class="form-group">
                            <label>Proprietario</label>
                            <input type="text" id="newOwnerName" placeholder="Nome proprietario">
                        </div>
                        <div class="form-group">
                            <label>Telefono</label>
                            <input type="tel" id="newOwnerPhone" placeholder="Telefono">
                        </div>
                        <div class="form-group">
                            <label>Data Visita</label>
                            <input type="date" id="newVisitDate">
                        </div>
                    </div>
                    
                    <!-- Lifestyle Section for New Pet -->
                    <button class="btn btn-secondary" style="margin-top: 20px; width: 100%;" onclick="toggleNewPetLifestyleSection()" data-testid="toggle-new-pet-lifestyle-section-button">
                        üè† Stile di Vita ‚ñº
                    </button>
                    
                    <div id="newPetLifestyleSection" class="lifestyle-section">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Ambiente</label>
                                <select id="newPetLifestyle">
                                    <option value="">Seleziona...</option>
                                    <option value="indoor">Indoor</option>
                                    <option value="outdoor">Outdoor</option>
                                    <option value="misto">Misto</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Conviventi</label>
                                <select id="newPetHousehold" multiple>
                                    <option value="bambini">Bambini</option>
                                    <option value="anziani">Anziani</option>
                                    <option value="altri_cani">Altri cani</option>
                                    <option value="altri_gatti">Altri gatti</option>
                                    <option value="altri_animali">Altri animali</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Livello di attivit√†</label>
                                <select id="newPetActivityLevel">
                                    <option value="">Seleziona...</option>
                                    <option value="basso">Basso</option>
                                    <option value="medio">Medio</option>
                                    <option value="alto">Alto</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Tipo alimentazione</label>
                                <select id="newPetDietType">
                                    <option value="">Seleziona...</option>
                                    <option value="secco">Secco</option>
                                    <option value="umido">Umido</option>
                                    <option value="barf">BARF</option>
                                    <option value="misto">Misto</option>
                                    <option value="casalingo">Casalingo</option>
                                </select>
                            </div>
                            <div class="form-group full-width">
                                <label>Preferenze alimentari</label>
                                <input type="text" id="newPetDietPreferences" placeholder="Es: preferisce pollo, evita pesce...">
                            </div>
                            <div class="form-group full-width">
                                <label>Condizioni note</label>
                                <input type="text" id="newPetKnownConditions" placeholder="Es: insuff. renale, artrosi, allergie...">
                            </div>
                            <div class="form-group full-width">
                                <label>Farmaci attuali</label>
                                <input type="text" id="newPetCurrentMeds" placeholder="Farmaci in corso (opzionale)">
                            </div>
                            <div class="form-group full-width">
                                <label>Note comportamentali</label>
                                <input type="text" id="newPetBehaviorNotes" placeholder="Es: paure, ansia, aggressivit√†...">
                            </div>
                            <div class="form-group">
                                <label>Localit√† (opz.)</label>
                                <input type="text" id="newPetLocation" placeholder="Es: Milano">
                            </div>
                        </div>
                    </div>
                    
                    <div class="button-row" style="margin-top: 20px;">
                        <button class="btn btn-success" onclick="saveNewPet()" data-testid="save-new-pet-button">üíæ Salva Nuovo Pet</button>
                        <button class="btn btn-danger" onclick="cancelAddPet()" data-testid="cancel-add-pet-button">‚ùå Annulla</button>
                        <button id="btnTestAddPet" class="btn btn-secondary" onclick="testFillAddPet()" style="display:none;">üß™ Test</button>
                    </div>
                </div>
            </div>

            <!-- Page: Photos -->
            <div id="page-photos" class="page">
                <div class="page-header">
                    <h2>üì∑ Foto</h2>

                </div>
                <div class="card">
                    <div class="button-row">
                        <button class="btn btn-primary" onclick="document.getElementById('photoInput').click()" data-testid="add-photo-button">üìÅ Aggiungi foto</button>
                        <button class="btn btn-secondary" onclick="capturePhoto()" data-testid="capture-photo-button">üì∏ Scatta foto</button>
                        <button id="btnTestPhotos" class="btn btn-secondary" onclick="testFillPhotos()" style="display:none;">üß™ Test</button>
                        <input type="file" id="photoInput" accept="image/*" multiple style="display:none" onchange="addPhotos(event)">
                    </div>
                    <div id="photoGrid" class="photo-grid"></div>
                </div>
            </div>

            <!-- Page: Vitals -->
            <div id="page-vitals" class="page">
                <div class="page-header">
                    <h2>üìä Parametri Vitali</h2>

                </div>
                <div class="card">
                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label>Data/Ora rilevazione</label>
                            <input type="datetime-local" id="vitalDateTime">
                        </div>
                        <div class="form-group">
                            <label>Peso (kg)</label>
                            <input type="number" id="vitalWeight" step="0.1" placeholder="Peso">
                        </div>
                        <div class="form-group">
                            <label>Temperatura (¬∞C)</label>
                            <input type="number" id="vitalTemp" step="0.1" placeholder="Temp">
                        </div>
                        <div class="form-group">
                            <label>Freq. Cardiaca (bpm)</label>
                            <input type="number" id="vitalHR" placeholder="FC">
                        </div>
                        <div class="form-group">
                            <label>Freq. Respiratoria</label>
                            <input type="number" id="vitalRR" placeholder="FR">
                        </div>
                    </div>
                    <div class="button-row" style="margin-top: 10px;">
                        <button class="btn btn-success" onclick="recordVitals()" data-testid="record-vitals-button">üìä Registra</button>
                        <button class="btn btn-danger" onclick="resetVitals()" data-testid="reset-vitals-button">üßπ Azzera</button>
                        <button id="btnTestVitals" class="btn btn-secondary" onclick="testFillVitals()" style="display:none;">üß™ Test</button>
                    </div>
                    
                    <h3 style="margin-top: 20px;">Storico</h3>
                    <div class="chart-container">
                        <canvas id="vitalsChart"></canvas>
                    </div>
                    <div id="vitalsList" class="vitals-list"></div>
                </div>
            </div>

            <!-- Page: Diary -->
            <div id="page-diary" class="page">
                <div class="page-header">
                    <h2>üìî Profilo sanitario</h2>

                </div>
                <div class="card">
                    <div class="lang-selector" id="diaryLangSelector">
                        <button class="lang-btn" data-lang="IT" data-testid="diary-lang-it-button">IT</button>
                        <button class="lang-btn" data-lang="EN" data-testid="diary-lang-en-button">EN</button>
                        <button class="lang-btn" data-lang="DE" data-testid="diary-lang-de-button">DE</button>
                        <button class="lang-btn" data-lang="FR" data-testid="diary-lang-fr-button">FR</button>
                        <button class="lang-btn" data-lang="ES" data-testid="diary-lang-es-button">ES</button>
                    </div>
                    
                    <div class="textarea-wrapper">
                        <textarea id="diaryText" rows="15" placeholder="Profilo sanitario del paziente..."></textarea>
                        <button class="expand-btn" onclick="expandTextarea('diaryText', 'Profilo sanitario')" data-testid="expand-diary-button">‚õ∂</button>
                    </div>

                    <div class="button-row" style="margin-top: 15px;">
                        <button id="btnSpeakDiary" class="btn btn-secondary" onclick="speakDiary()" data-testid="speak-diary-button">üîä Leggi</button>
                        <button id="btnGenerateDiary" class="btn btn-primary" onclick="generateDiary()" data-testid="generate-diary-button">ü§ñ Genera</button>
                        <button id="btnSaveDiary" class="btn btn-success" onclick="saveDiary()" data-testid="save-diary-button">üíæ Salva</button>
                        <button id="btnExportDiaryTXT" class="btn btn-secondary" onclick="exportDiaryTXT()" data-testid="export-diary-txt-button">üìÑ TXT</button>
                        <button id="btnExportDiaryPDF" class="btn btn-secondary" onclick="exportDiaryPDF()" data-testid="export-diary-pdf-button">üìë PDF</button>
                    </div>
                </div>
            </div>

            <!-- Page: Q&A HUB -->
            <div id="page-qna" class="page">
                <div class="page-header">
                    <h2>‚ùì Domande & Risposte</h2>

                </div>
                <div class="card">
                    <p style="color:#666; margin-top:6px;">Scegli cosa vuoi fare:</p>
                    <div class="hub-grid">
                        <div class="hub-tile" onclick="navigateToPage('qna-report')">
                            <div class="hub-emoji">üìã</div>
                            <div class="hub-title">Domande su documento</div>
                            <div class="hub-sub">Apri o genera la spiegazione del documento da archivio</div>
                        </div>
                        <div class="hub-tile" onclick="navigateToPage('qna-pet')">
                            <div class="hub-emoji">üêæ</div>
                            <div class="hub-title">Domande sul tuo pet</div>
                            <div class="hub-sub">Fai una domanda e ottieni una risposta</div>
                        </div>
                        <div class="hub-tile" onclick="navigateToPage('tips')">
                            <div class="hub-emoji">üí°</div>
                            <div class="hub-title">Tips & Tricks</div>
                            <div class="hub-sub">Consigli personalizzati per il tuo pet</div>
                        </div>
                    </div>
                    <!-- Promo slot: faq_view (PR 3) -->
                    <div id="qna-promo-container"></div>
                </div>
            </div>

            <!-- Page: Q&A Pet -->
            <div id="page-qna-pet" class="page">
                <div class="page-header">
                    <h2>üêæ Domande sul pet</h2>

                </div>
                <div class="card">
                    <button id="btnAskQuestion" class="btn btn-primary" onclick="toggleQuestionRecording()" data-testid="ask-question-button">üé§ Chiedi</button>
                    <div class="textarea-wrapper" style="margin-top: 10px;">
                        <textarea id="qnaQuestion" rows="3" placeholder="La tua domanda..."></textarea>
                        <button class="expand-btn" onclick="expandTextarea('qnaQuestion', 'Domanda')" data-testid="expand-qna-question-button">‚õ∂</button>
                    </div>
                    
                    <h3 style="margin-top: 20px;">Risposta</h3>
                    <div class="textarea-wrapper">
                        <textarea id="qnaAnswer" rows="6" placeholder="La risposta apparir√† qui..." readonly></textarea>
                        <button class="expand-btn" onclick="expandTextarea('qnaAnswer', 'Risposta')" data-testid="expand-qna-answer-button">‚õ∂</button>
                    </div>
                    <div class="button-row" style="margin-top: 10px;">
                        <button class="btn btn-primary" onclick="generateQnAAnswer()" data-testid="generate-qna-answer-button">üí¨ Rispondi</button>
                        <button id="btnSpeakQnA" class="btn btn-secondary" onclick="speakQnAAnswer()" data-testid="speak-qna-button">üîä Leggi</button>
                    </div>
                    
                    <h3 style="margin-top: 20px;">Ti suggerisco io qualche domanda?</h3>
                    <button class="btn btn-secondary" onclick="generateQnAFaq()" data-testid="generate-qna-faq-button">üí° Genera suggerimenti</button>
                    <div id="qnaFaqList" class="faq-list"></div>
                </div>
            </div>

            <!-- Page: Q&A Report -->
            <div id="page-qna-report" class="page">
                <div class="page-header">
                    <h2>üìã Domande su documento</h2>

                </div>
                <div class="card">
                    <h3>Seleziona un documento dall'archivio</h3>
                    <div class="form-group" style="margin-top:10px;">
                        <label>Documento</label>
                        <select id="qnaReportSelect">
                            <option value="">-- Seleziona --</option>
                        </select>
                        <p style="font-size:12px;color:#888;margin-top:6px;">Suggerimento: se la spiegazione del documento √® gi√† presente nel record, verr√† riaperta senza rigenerarla.</p>
                    </div>
                    <div class="button-row" style="margin-top: 10px;">
                        <button class="btn btn-primary" onclick="openOrGenerateOwnerFromSelectedReport()" data-testid="open-owner-from-report-button">üìñ Spiegami il documento</button>
                        <button class="btn btn-secondary" onclick="navigateToPage('history')" data-testid="go-to-history-button">üìÅ Vai all'Archivio Sanitario</button>
                    </div>
                </div>
            </div>

            <!-- Page: Tips -->
            <div id="page-tips" class="page">
                <div class="page-header">
                    <h2>üí° Tips & Tricks</h2>
                    <div id="tipsMeta" class="tips-meta" data-testid="tips-meta"></div>

                </div>
                <div class="card">
                    <div class="button-row">
                        <button class="btn btn-primary" onclick="generateTipsTricks()" data-testid="generate-tips-button">üîÑ Genera</button>
                        <button class="btn btn-danger" onclick="resetTipsMemory()" title="Reset memoria Tips per questo pet" data-testid="reset-tips-button">‚ü≤ Ricomincia</button>
                        <button id="btnSpeakTips" class="btn btn-secondary" onclick="speakTips()" data-testid="speak-tips-button">üîä Leggi</button>
                    </div>
                    <div id="tipsTricksList" class="tips-list">
                        <p style="color: #888; text-align: center; padding: 40px;">Premi "Genera" per ricevere consigli personalizzati per il tuo pet</p>
                    </div>
                </div>
            </div>

            <!-- Page: History -->
            <div id="page-history" class="page">
                <div class="page-header">
                    <h2>üìÅ Archivio Sanitario</h2>

                </div>
                <div class="card">
                    <div class="button-row" style="margin-bottom:15px;">
                        <button class="btn btn-primary" onclick="triggerDocumentUpload()" data-testid="upload-document-button">üìÑ Carica Documento</button>
                        <input type="file" id="documentFileInput" accept=".pdf,.jpg,.jpeg,.png,.webp" style="display:none" onchange="handleDocumentUpload(event)">
                    </div>
                    <div id="documentUploadLoader"></div>
                    <div id="historyList" class="history-list"></div>
                    <p class="history-note">Nota: tieni premuto un referto per mostrare la ‚Äúx‚Äù e cancellarlo.</p>
                </div>
            </div>

            <!-- Page: Medications -->
            <div id="page-medications" class="page">
                <div class="page-header">
                    <h2>üíä Farmaci</h2>

                </div>
                <div class="card">
                    <button class="btn btn-primary" onclick="openMedicationModal()" data-testid="add-medication-button">+ Aggiungi Farmaco</button>
                    <button id="btnSpeakMeds" class="btn btn-secondary" onclick="speakMedications()" data-testid="speak-medications-button">üîä Leggi Farmaci</button>
                    <button id="btnTestMeds" class="btn btn-secondary" onclick="testFillMedications()" style="display:none;">üß™ Test</button>
                    <div id="medicationList" class="medication-list"></div>
                </div>
            </div>

            <!-- Page: Appointment (REMOVED - PR 3) ‚Äî redirect to home -->

            <!-- Page: Document viewer (PR 8) -->
            <div id="page-document" class="page">
                <div class="page-header">
                    <h2 id="documentTitle">üìÑ Documento</h2>
                </div>
                <div class="card">
                    <div id="documentViewer" style="min-height:200px; text-align:center; color:#888;">
                        Seleziona un documento dall'Archivio Sanitario.
                    </div>
                    <div id="documentMeta" style="margin-top:10px; font-size:12px; color:#888;"></div>
                    <div id="documentAiContainer" style="margin-top:15px;"></div>
                    <div class="button-row" style="margin-top:15px;">
                        <button id="btnDocRead" class="btn btn-primary" onclick="readDocument()" disabled data-testid="doc-read-button">üîç Trascrivi</button>
                        <button id="btnDocExplain" class="btn btn-secondary" onclick="explainDocument()" disabled data-testid="doc-explain-button">üí¨ Spiegami il documento</button>
                    </div>
                    <div id="documentReadResult" style="margin-top:15px; display:none;">
                        <h3>Testo trascritto</h3>
                        <div id="documentReadContent" class="card" style="background:#f9f9f9;"></div>
                    </div>
                </div>
            </div>

            <!-- Page: Settings -->
            <div id="page-settings" class="page">
                <div class="page-header">
                    <h2>‚öôÔ∏è Impostazioni</h2>

                </div>
                <!-- Consent banner (PR 3) -->
                <div id="settings-consent-container"></div>
                <div class="card">
                    <button class="section-toggle" onclick="toggleSpeakersSection()" data-testid="toggle-speakers-section-button">
                        <span>üé§ Parlanti (Reference Clips)</span>
                        <span id="speakersToggleIcon" class="toggle-icon">‚ñ∏</span>
                    </button>
                    <div id="speakersSectionBody" style="display:none;">
                    <p style="color:#666;font-size:13px;margin-bottom:15px;">
                        Configura i parlanti con nome e ruolo. Le clip audio (2-10s) migliorano l'identificazione vocale.
                    </p>
                    
                    <div id="speakersContainer" class="speakers-section"></div>
                    
                    <button id="btnAddSpeaker" class="btn btn-primary" onclick="addNewSpeaker()" style="margin-top:15px;" data-testid="add-speaker-button">
                        ‚ûï Aggiungi Parlante (max 4)
                    </button>
                    </div>
                </div>
                
                <div class="card">
                    <h3>Informazioni clinica</h3>
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label>Nome veterinario</label>
                        <input type="text" id="vetNameInput" placeholder="Es: Dott. Rossi" oninput="saveVetName(this.value)">
                        <p style="font-size: 12px; color: #888; margin-top: 5px;">Usato in export e, dove previsto, nelle comunicazioni al proprietario</p>
                    </div>
                    <button class="section-toggle" onclick="toggleClinicLogoSection()" data-testid="toggle-clinic-logo-section-button">
                        <span>Logo clinica</span>
                        <span id="clinicLogoToggleIcon" class="toggle-icon">‚ñ∏</span>
                    </button>
                    <div id="clinicLogoSectionBody" style="display:none;">
                        <p style="color:#666;font-size:13px;margin-bottom:10px;">
                            Carica il logo che comparir√† nell'intestazione delle pagine e nei PDF esportati.
                        </p>
                        <div class="clinic-logo-upload">
                            <img id="clinicLogoPreview" src="logo-anicura.png" alt="Logo clinica" class="clinic-logo-preview" data-testid="clinic-logo-preview">
                            <div class="button-row">
                                <label class="btn btn-secondary" data-testid="clinic-logo-upload-button">
                                    üì§ Carica logo
                                    <input type="file" id="clinicLogoInput" accept="image/*" style="display:none;" data-testid="clinic-logo-input">
                                </label>
                                <button class="btn btn-secondary" onclick="resetClinicLogo()" data-testid="reset-clinic-logo-button">‚Ü©Ô∏è Ripristina</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>Sistema</h3>
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="debugLogEnabled" onchange="toggleDebugLog(this.checked)" checked>
                            <span>Debug attivo (per i test)</span>
                        </label>
                        <p style="font-size: 12px; color: #888; margin-top: 5px;">Disattiva per migliorare le performance in produzione</p>
                    </div>
                    
                    <h3 style="margin-top: 20px;">Informazioni</h3>
                        <p><strong>Versione:</strong> ADA v<span id="appVersion">--</span></p>
                    <p><strong>Novit√† v<span id="appReleaseNotesVersion">--</span>:</strong> Registrazione lunga a chunk con trascrizione in parallelo, profili automatici per dispositivo, UI runtime della coda, cache audio test e debug avanzato.</p>
                </div>
            </div>

            <!-- Page: Admin Dashboard (PR 4) -->
            <div id="page-admin-dashboard" class="page">
                <div class="page-header">
                    <h2>Dashboard Promo</h2>
                </div>
                <div class="card">
                    <div id="admin-dashboard-content"></div>
                </div>
            </div>

            <!-- Page: Admin Catalog (PR 4) -->
            <div id="page-admin-catalog" class="page">
                <div class="page-header">
                    <h2>Catalogo Prodotti</h2>
                </div>
                <div class="card">
                    <p style="color:#666;">Gestisci i prodotti promozionali dal pannello admin.</p>
                    <div id="admin-catalog-content"></div>
                </div>
            </div>

            <!-- Page: Admin Campaigns (PR 4) -->
            <div id="page-admin-campaigns" class="page">
                <div class="page-header">
                    <h2>Campagne</h2>
                </div>
                <div class="card">
                    <p style="color:#666;">Gestisci le campagne promozionali.</p>
                    <div id="admin-campaigns-content"></div>
                </div>
            </div>

            <!-- Page: Admin Wizard (PR 4) -->
            <div id="page-admin-wizard" class="page">
                <div class="page-header">
                    <h2>Importa CSV</h2>
                </div>
                <div class="card">
                    <div id="admin-wizard-content"></div>
                </div>
            </div>

            <!-- Page: Debug -->
            <div id="page-debug" class="page" style="display:none;">
                <div class="page-header">
                    <h2>üõ† Debug</h2>
                </div>
                <div class="card" style="margin-bottom:15px;">
                    <label style="font-weight:600; margin-bottom:8px; display:block;">Ruolo attivo</label>
                    <div id="roleToggleContainer" class="role-toggle-container">
                        <button id="roleToggleBtn" class="role-toggle-btn" onclick="toggleActiveRole()" data-testid="role-toggle-button">
                            <span id="roleToggleIcon">ü©∫</span>
                            <span id="roleToggleLabel">Veterinario</span>
                        </button>
                    </div>
                </div>
                <div class="card">
                    <button class="section-toggle" onclick="toggleChunkingSection()" data-testid="toggle-chunking-section-button">
                        <span>üéöÔ∏è Registrazione a chunk (robusta)</span>
                        <span id="chunkingToggleIcon" class="toggle-icon">‚ñ∏</span>
                    </button>
                    <div id="chunkingSectionBody" style="display:none;" data-testid="chunking-section-body">
                        <p style="color:#666;font-size:13px;margin-bottom:10px;">
                            Default consigliati: Windows 20 min ‚Ä¢ Android 15 min ‚Ä¢ iPhone 10 min. Il profilo viene scelto automaticamente e mostrato qui.
                        </p>

                        <div class="form-group" style="margin-bottom: 12px;">
                            <label style="display:flex;align-items:center;gap:10px;">
                                <input type="checkbox" id="chunkingEnabled" onchange="toggleChunkingEnabled(this.checked)" data-testid="chunking-enabled-toggle">
                                <span>Abilita registrazione a chunk (consigliata)</span>
                            </label>
                        </div>

                        <div class="form-grid" style="grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div class="form-group">
                                <label>Profilo in uso (auto)</label>
                                <input type="text" id="chunkingProfile" readonly data-testid="chunking-profile">
                            </div>
                            <div class="form-group">
                                <label>mimeType attivo (auto)</label>
                                <input type="text" id="chunkingMimeType" readonly data-testid="chunking-mimetype">
                            </div>
                            <div class="form-group">
                                <label>chunkDurationSec</label>
                                <input type="number" id="chunkDurationSec" min="60" step="10" data-testid="chunk-duration-input">
                            </div>
                            <div class="form-group">
                                <label>timesliceMs</label>
                                <input type="number" id="timesliceMs" min="250" step="50" data-testid="chunk-timeslice-input">
                            </div>
                            <div class="form-group">
                                <label>maxPendingChunks</label>
                                <input type="number" id="maxPendingChunks" min="1" step="1" data-testid="chunk-max-pending-input">
                            </div>
                            <div class="form-group">
                                <label>maxConcurrentTranscriptions</label>
                                <input type="number" id="maxConcurrentTranscriptions" min="1" step="1" data-testid="chunk-max-concurrent-input">
                            </div>
                            <div class="form-group">
                                <label>uploadRetryCount</label>
                                <input type="number" id="uploadRetryCount" min="0" step="1" data-testid="chunk-retry-count-input">
                            </div>
                            <div class="form-group">
                                <label>uploadRetryBackoffMs</label>
                                <input type="number" id="uploadRetryBackoffMs" min="200" step="100" data-testid="chunk-retry-backoff-input">
                            </div>
                            <div class="form-group">
                                <label>hardStopAtMb</label>
                                <input type="number" id="hardStopAtMb" min="1" step="1" data-testid="chunk-hard-stop-input">
                            </div>
                            <div class="form-group">
                                <label>warnBeforeSplitSec</label>
                                <input type="number" id="warnBeforeSplitSec" min="0" step="1" data-testid="chunk-warn-before-input">
                            </div>
                            <div class="form-group full-width">
                                <label>autoSplitGraceMs</label>
                                <input type="number" id="autoSplitGraceMs" min="0" step="50" data-testid="chunk-split-grace-input">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card" data-testid="debug-system-tools">
                    <div style="display:flex; flex-wrap:wrap; gap:8px;">
                        <button class="btn btn-primary" onclick="openCostsPage()" data-testid="open-costs-button">üí∞ Consumo API</button>
                        <button class="btn btn-secondary" onclick="exportLogFile()" data-testid="export-log-button">üìÑ Scarica ADA.log</button>
                        <button class="btn btn-secondary" onclick="clearLog(); showToast('Log cancellato', 'success');" data-testid="clear-log-button">Cancella ADA.log</button>
                    </div>
                </div>
                <div id="debugTestTools" class="card" style="display:none;">
                    <p style="margin: 0 0 10px; color: #666; font-size: 12px;">üß™ Strumenti di test (debug)</p>
                    <div class="button-row">
                        <button class="btn btn-secondary" onclick="triggerLongAudioTestUpload()" data-testid="long-audio-test-button">üß™ Carica audio lungo</button>
                        <button class="btn btn-secondary" onclick="triggerLongTextTestUpload()" data-testid="long-text-test-button">üß™ Carica testo lungo</button>
                    </div>
                    <input type="file" id="longAudioTestInput" accept="audio/*,.webm,.mp3,.wav,.m4a,.mp4,.ogg" style="display:none" onchange="handleLongAudioTestUpload(event)">
                    <input type="file" id="longTextTestInput" accept=".txt,.text" style="display:none" onchange="handleLongTextTestUpload(event)">
                    <p style="font-size: 11px; color: #888; margin-top: 6px;">Audio test: processa il file come se fossero chunk. Testo test: simula arrivo incrementale per stressare append/persistenza.</p>
                </div>
                <div id="audioCacheTools" class="card" style="display:none;">
                    <p style="font-size: 12px; color: #666; margin: 0 0 8px;">Cache audio di test (salvata solo con Debug ON)</p>
                    <div class="button-row">
                        <button class="btn btn-secondary" onclick="exportSavedAudioChunks()" data-testid="export-saved-audio-chunks-button">üì¶ Esporta file audio</button>
                        <button class="btn btn-secondary" onclick="clearSavedAudioChunks()" data-testid="clear-saved-audio-chunks-button">üóëÔ∏è Cancella file audio</button>
                    </div>
                    <p id="audioCacheInfo" style="font-size: 12px; color: #888; margin-top: 6px;" data-testid="audio-cache-info"></p>
                </div>
            </div>

            <!-- Page: Costs -->
            <div id="page-costs" class="page">
                <div class="page-header">
                    <h2>üí∞ Consumo API</h2>

                </div>
                <div class="card">
                    <div id="costList" class="cost-list" data-testid="cost-list"></div>
                    <div class="cost-total-box">
                        <span>TOTALE STIMATO</span>
                        <span id="totalCost" class="cost-total-amount" data-testid="total-cost">$ 0.00</span>
                    </div>
                    <p id="lastResetInfo" class="last-reset-info" data-testid="last-reset-info">Ultimo azzeramento: mai</p>
                    <button class="btn btn-danger" onclick="resetCosts()" data-testid="reset-costs-button">üîÑ Azzera contatori</button>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal: Medication -->
    <div id="medicationModal" class="modal">
        <div class="modal-content">
            <h3 id="medicationModalTitle">Aggiungi Farmaco</h3>
            <div class="form-group">
                <label>Nome farmaco</label>
                <input type="text" id="medName" placeholder="Nome">
            </div>
            <div class="form-group">
                <label>Dosaggio</label>
                <input type="text" id="medDosage" placeholder="Es: 5mg">
            </div>
            <div class="form-group">
                <label>Frequenza</label>
                <input type="text" id="medFrequency" placeholder="Es: BID, q12h">
            </div>
            <div class="form-group">
                <label>Durata</label>
                <input type="text" id="medDuration" placeholder="Es: 7 giorni">
            </div>
            <div class="form-group">
                <label>Istruzioni</label>
                <textarea id="medInstructions" rows="2" placeholder="Istruzioni speciali..."></textarea>
            </div>
            <div class="button-row">
                <button id="medicationModalSaveBtn" class="btn btn-success" onclick="saveMedication()" data-testid="medication-modal-save-button">‚úÖ Aggiungi</button>
                <button class="btn btn-secondary" onclick="closeMedicationModal()" data-testid="medication-modal-cancel-button">‚ùå Annulla</button>
            </div>
        </div>
    </div>

    <!-- Modal: Fullscreen Textarea -->
    <div id="textareaFullscreen" class="modal">
        <div class="modal-content fullscreen-modal">
            <h3 id="fullscreenTitle" style="margin-bottom: 15px; text-align: center;">Testo</h3>
            <div class="fullscreen-buttons" style="margin-bottom: 15px;">
                <button id="btnSpeakFullscreen" class="btn btn-primary" onclick="speakFullscreenText()" data-testid="speak-fullscreen-button">üîä Leggi</button>
                <button id="btnCorrectFullscreen" class="btn btn-secondary" onclick="startFullscreenCorrection()" data-testid="correct-fullscreen-button">üé§ Correggi</button>
                <button class="btn btn-secondary" onclick="closeFullscreenTextarea()" data-testid="close-fullscreen-button">‚úï Chiudi</button>
            </div>
            <div id="fullscreenCorrectionButtons" class="correction-buttons" style="display: none; margin-bottom: 15px;">
                <button class="btn btn-danger" onclick="cancelFullscreenCorrection()" data-testid="cancel-fullscreen-correction-button">‚ùå Annulla</button>
                <button class="btn btn-success" onclick="sendFullscreenCorrection()" data-testid="send-fullscreen-correction-button">‚úÖ Invia correzione</button>
            </div>
            <textarea id="fullscreenTextarea" class="fullscreen-textarea"></textarea>
        </div>
    </div>
    
    <!-- Modal: Credit Exhausted -->
    <div id="creditExhaustedModal" class="modal">
        <div class="modal-content" style="text-align: center;">
            <h3 style="color: var(--error);">‚ö†Ô∏è Credito API Esaurito</h3>
            <p style="margin: 20px 0;">Il credito delle API OpenAI √® esaurito. Contatta l'amministratore per ricaricare il credito.</p>
            <button class="btn btn-primary" onclick="closeCreditExhaustedModal()" data-testid="close-credit-exhausted-button">OK, Ho capito</button>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast" data-testid="toast"></div>
    
    <!-- Progress Bar -->
    <div id="progressBar" class="progress-bar" data-testid="progress-bar"><div class="progress-fill"></div></div>

    <!-- Scripts -->
    <script>
      if (!window.ADA_API_BASE_URL && !["localhost", "127.0.0.1"].includes(window.location.hostname)) {
        window.ADA_API_BASE_URL = "https://ada-au40.onrender.com";
      }
    </script>
    <script src="config.js"></script>
    <script src="app-loading.js"></script>
    <script src="app-core.js"></script>
    <script src="app-recording.js"></script>
    <script src="app-soap.js"></script>
    <script src="app-tts.js"></script>
    <script src="app-data.js"></script>
    <script src="pets-sync-merge.js"></script>
    <script src="pets-coalesce.js"></script>
    <script src="app-pets.js"></script>
	<script src="pets-sync-step4.js"></script>
	<script src="pets-sync-bootstrap.js"></script>
    <script src="app-tips.js"></script>
    <script src="app-documents.js"></script>
    <script src="app-promo.js"></script>
    <script src="app-admin.js"></script>
    <script src="sync-engine.js"></script>
    <script src="app-observability.js"></script>
    <script src="app-testdata.js"></script>
</body>
</html>