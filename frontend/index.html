<!-- docs/index.html v3 (spa fallback enabled) -->
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADA - AI Driven AbuPet</title>
        <link rel="icon" href="logo-abupet.png" type="image/png">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0f766e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ADA">
    <link rel="apple-touch-icon" href="logo-abupet.png">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&display=swap" rel="stylesheet">
<link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://unpkg.com/lucide@0.344.0/dist/umd/lucide.min.js"></script>
  <script src="./spa-redirect.js"></script>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
        <div class="login-card">
            <img src="logo-abupet.png" alt="ADA Logo" class="login-logo">
            <h1>ADA</h1>
            <p>AI Driven AbuPet</p>
            <p id="loginVersion" class="login-version" style="position:absolute; bottom:10px; right:15px; font-size:11px; color:#fff; margin:0; opacity:0.7;"></p>
            <form onsubmit="event.preventDefault(); login();" autocomplete="on">
            <input type="email" id="emailInput" placeholder="Email" data-testid="email-input" autocomplete="username" onkeypress="if(event.key==='Enter')document.getElementById('passwordInput').focus()">
            <input type="password" id="passwordInput" placeholder="Password" autocomplete="current-password" onkeypress="if(event.key==='Enter')login()">
            <button type="submit" class="btn btn-primary" id="loginButton" data-testid="login-button">Accedi</button>
            </form>
            <div id="loginSpinner" style="display:none; margin-top:12px; text-align:center;">
                <div class="login-spinner"></div>
                <p id="loginSpinnerText" style="font-size:13px; color:#888; margin-top:8px;"></p>
            </div>
            <p id="loginError" class="error" style="display:none;" data-testid="login-error">Credenziali non valide</p>
        </div>
    </div>

    <!-- App Container -->
    <div id="appContainer" class="app-container">
        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <img src="logo-abupet.png" alt="ADA" class="sidebar-logo">
                <span class="sidebar-title">ADA</span>
                <button class="sidebar-close" onclick="toggleSidebar()" aria-label="Chiudi menu" data-testid="close-sidebar-button">√ó</button>
            </div>
            
            <nav class="sidebar-nav">
                <!-- Sidebar: Veterinario -->
                <div id="sidebar-vet" class="sidebar-role-section">
                    <div class="nav-section">VISITA</div>
                    <div class="nav-item" data-page="patient"><i data-lucide="paw-print" class="icon"></i> Dati Pet</div>
                    <div class="nav-item active" data-page="recording"><i data-lucide="mic" class="icon"></i> Registrazione</div>
                    <div class="nav-item" data-page="soap"><i data-lucide="clipboard-list" class="icon"></i> Referto</div>
                    <div class="nav-item" data-page="nutrition"><i data-lucide="salad" class="icon"></i> Nutrizione</div>
                    <div class="nav-item" data-page="history"><i data-lucide="folder-open" class="icon"></i> Archivio Sanitario <span class="badge" id="historyBadge" data-testid="history-badge">0</span></div>
                    <div class="nav-item" data-page="diary"><i data-lucide="book-heart" class="icon"></i> Profilo Sanitario</div>
                    <div class="nav-item" data-page="communication"><i data-lucide="message-circle" class="icon"></i> Messaggi <span class="badge" id="comm-unread-badge-vet" style="display:none;">0</span></div>
                </div>

                <!-- Sidebar: Proprietario -->
                <div id="sidebar-owner" class="sidebar-role-section" style="display:none;">
                    <div class="nav-section">I MIEI AMICI ANIMALI</div>
                    <div class="nav-item" data-page="patient"><i data-lucide="paw-print" class="icon"></i> Dati Pet</div>
                    <div class="nav-item" data-page="nutrition"><i data-lucide="salad" class="icon"></i> Nutrizione</div>
                    <div class="nav-item" data-page="diary"><i data-lucide="book-heart" class="icon"></i> Profilo Sanitario</div>
                    <div class="nav-item" data-page="vitals"><i data-lucide="activity" class="icon"></i> Parametri Vitali</div>
                    <div class="nav-item" data-page="medications"><i data-lucide="pill" class="icon"></i> Farmaci</div>
                    <div class="nav-item" data-page="history"><i data-lucide="folder-open" class="icon"></i> Archivio Sanitario <span class="badge" id="historyBadgeOwner" data-testid="history-badge-owner">0</span></div>
                    <div class="nav-item" data-page="qna"><i data-lucide="help-circle" class="icon"></i> Domande & Risposte</div>
                    <div class="nav-item" data-page="photos"><i data-lucide="camera" class="icon"></i> Foto</div>
                    <div class="nav-item" data-page="communication"><i data-lucide="message-circle" class="icon"></i> Messaggi <span class="badge" id="comm-unread-badge-owner" style="display:none;">0</span></div>
                </div>

                <!-- Sidebar: TEST & DEMO (super_admin only) -->
                <div id="sidebar-test-demo" class="sidebar-role-section" style="display:none;">
                    <div class="nav-section">TEST & DEMO</div>
                    <div class="nav-item seed-nav-item" data-page="seed"><i data-lucide="sprout" class="icon"></i> Seed Engine</div>
                </div>

                <!-- Sidebar: Admin Brand / Super Admin -->
                <div id="sidebar-admin" class="sidebar-role-section" style="display:none;">
                    <div class="nav-section">ADMIN PROMO</div>
                    <div class="nav-item" data-page="admin-dashboard">Dashboard</div>
                    <div class="nav-item" data-page="admin-catalog">Catalogo</div>
                    <div class="nav-item" data-page="admin-campaigns">Campagne</div>
                    <div class="nav-item" data-page="admin-wizard">Importa file</div>
                </div>

                <div class="nav-section">SISTEMA</div>
                <div class="nav-item" id="nav-superadmin-gestione" data-page="superadmin-gestione" style="display:none;"><i data-lucide="wrench" class="icon"></i> Gestione</div>
                <div class="nav-item" data-page="settings"><i data-lucide="settings" class="icon"></i> Impostazioni</div>
                <div class="nav-item" id="nav-debug" data-page="debug" style="display:none;"><i data-lucide="bug" class="icon"></i> Debug</div>
                <div class="nav-item" id="nav-ai-petdesc" data-page="ai-petdesc" style="display:none;"><i data-lucide="sparkles" class="icon"></i> Descrizione Pet per AI</div>
                <div class="nav-item" onclick="logout()"><i data-lucide="log-out" class="icon"></i> Esci</div>
            </nav>
        </aside>
        <button id="sidebarOverlay" class="sidebar-overlay" type="button" aria-label="Chiudi menu" onclick="setSidebarOpen(false)"></button>

        <!-- Main Content -->
        <main class="main-content">
            <div class="topbar">
                <div class="topbar-left">
                    <button class="hamburger" onclick="toggleSidebar()" data-testid="toggle-sidebar-button">‚ò∞</button>
                </div>
                <div class="topbar-center">
                    <div class="selected-pet-header" data-selected-pet-header></div>
                    <!-- Role toggle moved to Debug page -->
                </div>
                <div class="topbar-right">
                    <img id="clinicLogo" src="logo-anicura.png" alt="Logo clinica" class="topbar-logo" data-testid="clinic-logo">
                </div>
            </div>
            
            <!-- Hidden image for PDF export -->
            <img id="anicuraLogoImg" src="logo-anicura.png" style="display:none;" crossorigin="anonymous">
            
            <!-- Page: Recording -->
            <div id="page-recording" class="page active">
                <div class="page-header">
                    <h2>üéôÔ∏è Registrazione</h2>
                </div>
                <div class="card">
                    <button class="btn btn-secondary" style="margin-bottom:12px;" onclick="resetRecordingAndReport()" data-testid="new-recording-button">üÜï Nuova</button>
                </div>
                
                <div class="card">
                    <div class="record-section">
                        <button id="recordBtn" class="record-btn" onclick="toggleRecording()" data-testid="record-button">üé§</button>
                        <div id="timer" class="timer" data-testid="recording-timer">00:00</div>
                        <div id="visualizer" class="visualizer" data-testid="recording-visualizer"></div>
                        <p id="recordingStatus" class="recording-status" data-testid="recording-status">Premi per registrare</p>
                        <div id="lowVoiceWarning" style="display:none; background:#ff4444; color:#fff; padding:6px 12px; border-radius:6px; margin:6px 0; font-size:13px; text-align:center; transition: opacity 0.3s;" data-testid="low-voice-warning">üîá Volume troppo basso ‚Äî avvicina il microfono</div>

                        <!-- Chunk recording runtime info (visible when chunking is enabled) -->
                        <div id="chunkingRuntime" class="chunking-runtime" style="display:none;" data-testid="chunking-runtime">
                            <div class="chunking-badges">
                                <span id="chunkProfileBadge" class="chip" data-testid="chunk-profile-badge">Profilo: ‚Äî</span>
                                <span id="chunkDurationBadge" class="chip" data-testid="chunk-duration-badge">Chunk: ‚Äî</span>
                                <span id="chunkMimeBadge" class="chip" data-testid="chunk-mime-badge">mimeType: ‚Äî</span>
                                <span id="chunkingOnBadge" class="chip chip-green" data-testid="chunking-on-badge">Chunking ON</span>
                            </div>
                            <div class="chunking-status" data-testid="chunking-status">
                                <div id="chunkTimerLine" class="chunking-line" data-testid="chunk-timer-line">Chunk: 00:00 / 00:00</div>
                                <div id="chunkQueueLine" class="chunking-line" data-testid="chunk-queue-line">In coda: 0 ‚Ä¢ In trascrizione: 0</div>
                                <div id="chunkWarnLine" class="chunking-warn" style="display:none;" data-testid="chunk-warn-line">‚ö†Ô∏è Tra ‚Äîs spezzetto il chunk</div>
                            </div>
                        </div>
                        
                        
                        <div class="record-controls">
                            <button id="btnPause" class="btn btn-secondary" onclick="pauseRecording()" disabled data-testid="pause-recording-button">‚è∏Ô∏è Pausa</button>
                            <button id="btnResume" class="btn btn-secondary" onclick="resumeRecording()" disabled data-testid="resume-recording-button">‚ñ∂Ô∏è Riprendi</button>
                            <button id="btnCancel" class="btn btn-danger" onclick="cancelVisitProcess()" disabled data-testid="cancel-visit-button">‚úñÔ∏è Annulla</button>
                        </div>

                        
                        <div class="upload-section">
                            <p style="margin: 15px 0 10px; color: #666;">oppure</p>
                            <div class="button-row">
                                <button class="btn btn-secondary" onclick="triggerAudioUpload()" data-testid="upload-audio-button">üìÅ Carica audio</button>
                                <button class="btn btn-secondary" onclick="triggerTextUpload()" data-testid="upload-text-button">üìÑ Carica testo</button>
                            </div>

                            <!-- Debug-only test tools -->
                            <input type="file" id="audioFileInput" accept="audio/*,.mp3,.wav,.webm,.ogg,.m4a" style="display:none" onchange="handleAudioUpload(event)">
                            <input type="file" id="textFileInput" accept=".txt,.text" style="display:none" onchange="handleTextUpload(event)">
                            <p style="font-size: 12px; color: #888; margin-top: 5px;">Audio: MP3, WAV, WEBM, OGG, M4A | Testo: TXT</p>

                        </div>
                    </div>
                </div>
                
                <div class="card" id="transcriptionCard" style="display:none;">
                    <h3 id="transcriptionTitle">Testo trascritto</h3>
                    <div class="textarea-wrapper">
                        <textarea id="transcriptionText" placeholder="La trascrizione o il testo caricato appariranno qui..." rows="8"></textarea>
                        <!-- Hidden legacy input (v6.17.x): used by generateSOAPFromPaste() as optional source -->
                        <textarea id="pasteText" style="display:none"></textarea>
                        <button class="expand-btn" onclick="expandTextarea('transcriptionText', 'Trascrizione')" data-testid="expand-transcription-button">‚õ∂</button>
                    </div>
                    <div id="transcriptionReadOnlyNote" class="readonly-note" style="display:none;" data-testid="transcription-readonly-note">
                        üîí Questo testo √® in sola lettura perch√© proviene da una trascrizione audio. Se vuoi correggerlo, modifica un file TXT e ricaricalo con ‚ÄúCarica file testo‚Äù.
                    </div>
                    <div id="generateSoapRow" class="button-row" style="margin-top: 10px; display:none;">
                        <button id="btnGenerateSoap" class="btn btn-primary" onclick="generateSOAP()" data-testid="generate-soap-button">üìã Genera Referto</button>
                    </div>
                    <div id="autoSoapCompleteRow" class="button-row" style="margin-top: 10px; display:none;">
                        <button id="btnOpenSoap" class="btn btn-success" onclick="navigateToPage('soap')" data-testid="open-soap-button">üìã Apri il referto</button>
                    </div>

                </div>
            </div>

            <!-- Page: SOAP -->
            <div id="page-soap" class="page">
                <div class="page-header">
                    <h2>üìã Referto</h2>
                </div>
                <div class="card">
                    <div class="form-group" style="margin-bottom:12px;">
                        <label>Titolo</label>
                        <input type="text" id="templateSelector" list="templateOptions" value="" placeholder="Scegli o digita un titolo..." onchange="onTemplateSelectorInput(this.value)">
                        <datalist id="templateOptions">
                            <option value="Visita Generale">
                            <option value="Pronto Soccorso">
                            <option value="Cardiologia">
                            <option value="Controllo">
                            <option value="Dermatologia">
                            <option value="Medicina interna">
                            <option value="Neurologia">
                            <option value="Oncologia">
                            <option value="Ortopedia">
                            <option value="Pre-Chirurgia">
                            <option value="Vaccinazione">
                        </datalist>
                    </div>

                    <div class="lang-selector" id="soapLangSelector">
                        <button class="lang-btn" data-lang="IT" data-testid="soap-lang-it-button">IT</button>
                        <button class="lang-btn" data-lang="EN" data-testid="soap-lang-en-button">EN</button>
                        <button class="lang-btn" data-lang="DE" data-testid="soap-lang-de-button">DE</button>
                        <button class="lang-btn" data-lang="FR" data-testid="soap-lang-fr-button">FR</button>
                        <button class="lang-btn" data-lang="ES" data-testid="soap-lang-es-button">ES</button>
                    </div>

                    <div class="hide-empty-row">
                        <label class="switch" title="Nasconde campi vuoti e sezioni completamente vuote (solo nella UI)">
                            <input type="checkbox" id="hideEmptyToggle" onchange="setHideEmptyFields(this.checked)">
                            <span class="slider"></span>
                        </label>
                        <span class="hide-empty-label">Nascondi campi non compilati</span>
                    </div>
                    
                    <div class="soap-section soap-s">
                        <div class="soap-label">S</div>
                        <label id="labelSoapS">Soggettivo</label>
                        <div class="textarea-wrapper">
                            <textarea id="soap-s" rows="6" placeholder="Sintomi riferiti dal proprietario..."></textarea>
                            <button class="expand-btn" onclick="expandTextarea('soap-s', 'Soggettivo')" data-testid="expand-soap-s-button">‚õ∂</button>
                        </div>
                    </div>
                    
                    <div class="soap-section soap-o">
                        <div class="soap-label">O</div>
                        <label id="labelSoapO">Oggettivo</label>
                        <div class="textarea-wrapper">
                            <textarea id="soap-o" rows="6" placeholder="Esame obiettivo..."></textarea>
                            <button class="expand-btn" onclick="expandTextarea('soap-o', 'Oggettivo')" data-testid="expand-soap-o-button">‚õ∂</button>
                        </div>
                    </div>
                    
                    <div class="soap-section soap-a">
                        <div class="soap-label">A</div>
                        <label id="labelSoapA">Analisi clinica</label>
                        <div class="textarea-wrapper">
                            <textarea id="soap-a" rows="6" placeholder="Diagnosi/valutazione..."></textarea>
                            <button class="expand-btn" onclick="expandTextarea('soap-a', 'Analisi clinica')" data-testid="expand-soap-a-button">‚õ∂</button>
                        </div>
                    </div>
                    
                    <div class="soap-section soap-p">
                        <div class="soap-label">P</div>
                        <label id="labelSoapP">Piano</label>
                        <div class="textarea-wrapper">
                            <textarea id="soap-p" rows="6" placeholder="Piano terapeutico..."></textarea>
                            <button class="expand-btn" onclick="expandTextarea('soap-p', 'Piano')" data-testid="expand-soap-p-button">‚õ∂</button>
                        </div>
                    </div>

                    <!-- Note interne (non stampate, non visibili al proprietario) -->
                    <div class="soap-internal-notes" id="internalNotesSection">
                        <button class="soap-internal-toggle" onclick="toggleInternalNotes()" data-testid="toggle-internal-notes-button">
                            üìù Note interne (non stampate) <span class="toggle-icon" id="internalNotesToggleIcon">‚ñº</span>
                        </button>
                        <div class="soap-internal-body" id="internalNotesBody">
                            <div class="textarea-wrapper">
                                <textarea id="soap-internal-notes" rows="6" placeholder="Note ad uso interno: informazioni dalla trascrizione non incluse nel referto, appunti, promemoria..."></textarea>
                                <button class="expand-btn" onclick="expandTextarea('soap-internal-notes', 'Note interne')" data-testid="expand-internal-notes-button">‚õ∂</button>
                            </div>
                        </div>
                    </div>

                    <div class="soap-actions">
                        <button id="btnSpeakSOAP" class="btn btn-primary" onclick="speakSOAP()" data-testid="speak-soap-button">üîä Leggi</button>
                        <button class="btn btn-success" onclick="saveSOAP()" data-testid="save-soap-button">üíæ Salva</button>
                        <button class="btn btn-secondary" onclick="exportTXT()" data-testid="export-soap-txt-button">üìÑ TXT</button>
                        <button class="btn btn-secondary" onclick="exportPDF()" data-testid="export-soap-pdf-button">üìë PDF</button>
                        <button id="btnRecordCorrection" class="btn btn-secondary" onclick="startCorrectionRecording()" data-testid="record-correction-button">üé§ Correggi</button>
                        <button id="btnTestSoap" class="btn btn-secondary" onclick="testFillSoap()" style="display:none;">üß™ Test</button>
                    </div>
                    <div class="soap-actions" id="correctionButtonsRow" style="display:none; margin-top:8px;">
                        <div id="correctionButtons" class="correction-buttons">
                            <button class="btn btn-danger" onclick="cancelCorrection()" data-testid="cancel-correction-button">‚ùå Annulla</button>
                            <button class="btn btn-success" onclick="sendCorrection()" data-testid="send-correction-button">‚úÖ Invia correzione</button>
                        </div>
                    </div>

                    <button class="btn btn-primary btn-inline" id="btnGenerateOwnerExplanation" style="margin-top: 10px;" onclick="generateOwnerExplanation()" data-testid="generate-owner-explanation-button">üìñ Spiegami il documento</button>
                    <!-- Promo slot: post_visit (PR 3) -->
                    <div id="soap-promo-container"></div>
                </div>
            </div>

            <!-- Page: SOAP Read-Only (for owner viewing archived reports) -->
            <div id="page-soap-readonly" class="page">
                <div class="page-header">
                    <h2>üìã Referto</h2>
                </div>
                <div class="card" id="soapReadonlyCard">
                    <div id="soapReadonlyContent" class="soap-readonly-content">
                        <p style="color:#888; text-align:center; padding:20px;">Seleziona un referto dall'Archivio Sanitario.</p>
                    </div>
                    <div class="soap-actions" style="margin-top:15px;">
                        <button class="btn btn-primary btn-inline" id="btnExplainFromReadonly" onclick="generateOwnerExplanationFromReadonly()" data-testid="explain-from-readonly-button">üìñ Spiegami il documento</button>
                    </div>
                </div>
            </div>

            <!-- Page: Owner -->
            <div id="page-owner" class="page">
                <div class="page-header">
                    <h2>üìÑ Spiegazione Documento</h2>

                </div>
                <div class="card">
                    <div class="lang-selector" id="ownerLangSelector">
                        <button class="lang-btn" data-lang="IT" data-testid="owner-lang-it-button">IT</button>
                        <button class="lang-btn" data-lang="EN" data-testid="owner-lang-en-button">EN</button>
                        <button class="lang-btn" data-lang="DE" data-testid="owner-lang-de-button">DE</button>
                        <button class="lang-btn" data-lang="FR" data-testid="owner-lang-fr-button">FR</button>
                        <button class="lang-btn" data-lang="ES" data-testid="owner-lang-es-button">ES</button>
                    </div>
                    

                    <div class="textarea-wrapper">
                        <textarea id="ownerExplanation" rows="10" placeholder="Spiegazione per il proprietario..."></textarea>
                        <button class="expand-btn" onclick="expandTextarea('ownerExplanation', 'Spiegazione')" data-testid="expand-owner-explanation-button">‚õ∂</button>
                    </div>
                    
                    <div class="button-row">
                        <button id="btnSpeakOwner" class="btn btn-primary" onclick="speakOwnerExplanation()" data-testid="speak-owner-button">üîä Leggi</button>
                        <button class="btn btn-secondary" onclick="exportOwnerTXT()" data-testid="export-owner-txt-button">üìÑ TXT</button>
                        <button class="btn btn-secondary" onclick="exportOwnerPDF()" data-testid="export-owner-pdf-button">üìë PDF</button>
                    </div>
                    
                    <h3 style="margin-top: 20px;">Glossario</h3>
                    <div id="glossaryContent" class="glossary"></div>
                    
                    <h3 style="margin-top: 20px;">Ti suggerisco io qualche domanda?</h3>
                    <div class="button-row">
                        <button class="btn btn-primary" onclick="generateFAQ()" data-testid="generate-faq-button">üìù Genera Domande</button>
                        <button id="btnSpeakFAQ" class="btn btn-secondary" onclick="speakFAQ()" data-testid="speak-faq-button">üîä Leggi Domande</button>
                    </div>
                    <div id="faqList" class="faq-list"></div>
                    <!-- Promo slot: home_feed (PR 3) -->
                    <div id="owner-promo-container"></div>
                </div>
            </div>

            <!-- Page: Patient -->
            <div id="page-patient" class="page">
                <div class="page-header">
                    <h2>üêæ Dati Pet</h2>

                </div>
                
                <!-- Pet Selector Card -->
                <div class="card pet-selector-card">
                    <div class="form-group" style="margin: 0;">
                        <label>üêæ Seleziona Pet</label>
                        <select id="petSelector" style="width:100%;" onchange="onPetSelectorChange(this)">
                            <option value="">-- Seleziona Pet --</option>
                        </select>
                    </div>
                    <div class="pet-actions" style="display:flex; gap:8px; margin-top:10px; flex-wrap:wrap;">
                        <button id="btnEditPet" class="btn btn-primary btn-small" onclick="openEditPetModal()" title="Modifica Pet" disabled data-testid="edit-pet-button">‚úèÔ∏è Modifica</button>
                        <button id="addPetBtn" class="btn btn-small btn-add-pet" onclick="openAddPetPage()" title="Aggiungi nuovo Pet" data-testid="add-pet-button">‚ûï Aggiungi</button>
                        <button id="btnDeletePet" class="btn btn-danger btn-small" onclick="deleteCurrentPet()" title="Elimina Pet" disabled data-testid="delete-pet-button">üóëÔ∏è Elimina</button>
                    </div>
                </div>
                
                <div id="petFieldsCard" class="card" style="display:none;">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Nome Pet <span class="required">*</span></label>
                            <input type="text" id="petName" placeholder="Nome" required>
                        </div>
                        <div class="form-group">
                            <label>Specie <span class="required">*</span></label>
                            <select id="petSpecies" required>
                                <option value="">Seleziona...</option>
                                <option value="Cane">Cane</option>
                                <option value="Gatto">Gatto</option>
                                <option value="Coniglio">Coniglio</option>
                                <option value="Altro">Altro</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Razza</label>
                            <input type="text" id="petBreed" placeholder="Digita per cercare..." list="petBreedList" autocomplete="off">
                            <datalist id="petBreedList"></datalist>
                        </div>
                        <div class="form-group">
                            <label>Data di nascita</label>
                            <input type="date" id="petBirthdate">
                        </div>
                        <div class="form-group">
                            <label>Sesso</label>
                            <select id="petSex">
                                <option value="">Seleziona...</option>
                                <option value="Maschio">Maschio</option>
                                <option value="Maschio castrato">Maschio castrato</option>
                                <option value="Femmina">Femmina</option>
                                <option value="Femmina sterilizzata">Femmina sterilizzata</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Microchip</label>
                            <input type="text" id="petMicrochip" placeholder="N¬∞ Microchip">
                        </div>
                        <div class="form-group">
                            <label>üîí Proprietario</label>
                            <select id="ownerName" disabled>
                                <option value="">Caricamento...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>üîí Vet Esterno (referral)</label>
                            <select id="ownerReferringVet" disabled>
                                <option value="">‚Äî Nessuno ‚Äî</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Telefono</label>
                            <input type="tel" id="ownerPhone" placeholder="Telefono">
                        </div>
                        <div class="form-group">
                            <label>Data Visita</label>
                            <input type="date" id="visitDate">
                        </div>
                    </div>
                    
                    <!-- Lifestyle Section -->
                    <button class="btn btn-secondary" style="margin-top: 20px; width: 100%;" onclick="toggleLifestyleSection()" data-testid="toggle-lifestyle-section-button">
                        üè† Stile di Vita ‚ñº
                    </button>
                    
                    <div id="lifestyleSection" class="lifestyle-section">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Ambiente</label>
                                <select id="petLifestyle">
                                    <option value="">Seleziona...</option>
                                    <option value="indoor">Indoor</option>
                                    <option value="outdoor">Outdoor</option>
                                    <option value="misto">Misto</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Conviventi</label>
                                <select id="petHousehold" multiple>
                                    <option value="bambini">Bambini</option>
                                    <option value="anziani">Anziani</option>
                                    <option value="altri_cani">Altri cani</option>
                                    <option value="altri_gatti">Altri gatti</option>
                                    <option value="altri_animali">Altri animali</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Livello di attivit√†</label>
                                <select id="petActivityLevel">
                                    <option value="">Seleziona...</option>
                                    <option value="basso">Basso</option>
                                    <option value="medio">Medio</option>
                                    <option value="alto">Alto</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Tipo alimentazione</label>
                                <select id="petDietType">
                                    <option value="">Seleziona...</option>
                                    <option value="secco">Secco</option>
                                    <option value="umido">Umido</option>
                                    <option value="barf">BARF</option>
                                    <option value="misto">Misto</option>
                                    <option value="casalingo">Casalingo</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Peso ideale (kg)</label>
                                <input type="number" id="petIdealWeight" step="0.1" placeholder="Peso target" min="0.1" max="200">
                            </div>
                            <div class="form-group">
                                <label>Pasti al giorno</label>
                                <select id="petMealsPerDay">
                                    <option value="">Seleziona...</option>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4 (cuccioli)</option>
                                </select>
                            </div>
                            <div class="form-group full-width">
                                <label>Allergie alimentari</label>
                                <input type="text" id="petFoodAllergies" placeholder="Separare con virgola: pollo, mais, glutine...">
                            </div>
                            <div class="form-group full-width">
                                <label>Preferenze alimentari</label>
                                <input type="text" id="petDietPreferences" placeholder="Es: preferisce pollo, evita pesce...">
                            </div>
                            <div class="form-group full-width">
                                <label>Condizioni note</label>
                                <input type="text" id="petKnownConditions" placeholder="Es: insuff. renale, artrosi, allergie...">
                            </div>
                            <div class="form-group full-width">
                                <label>Farmaci attuali</label>
                                <input type="text" id="petCurrentMeds" placeholder="Farmaci in corso (opzionale)">
                            </div>
                            <div class="form-group full-width">
                                <label>Note comportamentali</label>
                                <input type="text" id="petBehaviorNotes" placeholder="Es: paure, ansia, aggressivit√†...">
                            </div>
                            <div class="form-group">
                                <label>Localit√† (opz.)</label>
                                <input type="text" id="petLocation" placeholder="Es: Milano">
                            </div>
                        </div>
                    </div>
                    <!-- Promo slot: pet_profile (PR 3) -->
                    <div id="patient-promo-container"></div>
                    <!-- Nutrition slot (multi-service) -->
                    <div id="patient-nutrition-container"></div>
                    <!-- Insurance slot (multi-service) -->
                    <div id="patient-insurance-container"></div>
                    <!-- Vet flag container (PR 3) -->
                    <div id="patient-vet-flag-container"></div>
                </div>
            </div>

            <!-- Page: Add New Pet -->
            <div id="page-addpet" class="page">
                <div class="page-header">
                    <h2>‚ûï Aggiungi Pet</h2>

                </div>
                
                <div class="card">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Nome Pet <span class="required">*</span></label>
                            <input type="text" id="newPetName" placeholder="Nome" required>
                        </div>
                        <div class="form-group">
                            <label>Specie <span class="required">*</span></label>
                            <select id="newPetSpecies" required>
                                <option value="">Seleziona...</option>
                                <option value="Cane">Cane</option>
                                <option value="Gatto">Gatto</option>
                                <option value="Coniglio">Coniglio</option>
                                <option value="Altro">Altro</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Razza</label>
                            <input type="text" id="newPetBreed" placeholder="Digita per cercare..." list="newPetBreedList" autocomplete="off">
                            <datalist id="newPetBreedList"></datalist>
                        </div>
                        <div class="form-group">
                            <label>Data di nascita</label>
                            <input type="date" id="newPetAge">
                        </div>
                        <div class="form-group">
                            <label>Sesso</label>
                            <select id="newPetSex">
                                <option value="">Seleziona...</option>
                                <option value="Maschio">Maschio</option>
                                <option value="Maschio castrato">Maschio castrato</option>
                                <option value="Femmina">Femmina</option>
                                <option value="Femmina sterilizzata">Femmina sterilizzata</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Microchip</label>
                            <input type="text" id="newPetMicrochip" placeholder="N¬∞ Microchip">
                        </div>
                        <div class="form-group">
                            <label>Proprietario</label>
                            <select id="newOwnerName">
                                <option value="">Caricamento...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Vet Esterno (referral)</label>
                            <select id="newOwnerReferringVet">
                                <option value="">‚Äî Nessuno ‚Äî</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Telefono</label>
                            <input type="tel" id="newOwnerPhone" placeholder="Telefono">
                        </div>
                        <div class="form-group">
                            <label>Data Visita</label>
                            <input type="date" id="newVisitDate">
                        </div>
                    </div>
                    
                    <!-- Lifestyle Section for New Pet -->
                    <button class="btn btn-secondary" style="margin-top: 20px; width: 100%;" onclick="toggleNewPetLifestyleSection()" data-testid="toggle-new-pet-lifestyle-section-button">
                        üè† Stile di Vita ‚ñº
                    </button>
                    
                    <div id="newPetLifestyleSection" class="lifestyle-section">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Ambiente</label>
                                <select id="newPetLifestyle">
                                    <option value="">Seleziona...</option>
                                    <option value="indoor">Indoor</option>
                                    <option value="outdoor">Outdoor</option>
                                    <option value="misto">Misto</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Conviventi</label>
                                <select id="newPetHousehold" multiple>
                                    <option value="bambini">Bambini</option>
                                    <option value="anziani">Anziani</option>
                                    <option value="altri_cani">Altri cani</option>
                                    <option value="altri_gatti">Altri gatti</option>
                                    <option value="altri_animali">Altri animali</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Livello di attivit√†</label>
                                <select id="newPetActivityLevel">
                                    <option value="">Seleziona...</option>
                                    <option value="basso">Basso</option>
                                    <option value="medio">Medio</option>
                                    <option value="alto">Alto</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Tipo alimentazione</label>
                                <select id="newPetDietType">
                                    <option value="">Seleziona...</option>
                                    <option value="secco">Secco</option>
                                    <option value="umido">Umido</option>
                                    <option value="barf">BARF</option>
                                    <option value="misto">Misto</option>
                                    <option value="casalingo">Casalingo</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Peso ideale (kg)</label>
                                <input type="number" id="newPetIdealWeight" step="0.1" placeholder="Peso target" min="0.1" max="200">
                            </div>
                            <div class="form-group">
                                <label>Pasti al giorno</label>
                                <select id="newPetMealsPerDay">
                                    <option value="">Seleziona...</option>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4 (cuccioli)</option>
                                </select>
                            </div>
                            <div class="form-group full-width">
                                <label>Allergie alimentari</label>
                                <input type="text" id="newPetFoodAllergies" placeholder="Separare con virgola: pollo, mais, glutine...">
                            </div>
                            <div class="form-group full-width">
                                <label>Preferenze alimentari</label>
                                <input type="text" id="newPetDietPreferences" placeholder="Es: preferisce pollo, evita pesce...">
                            </div>
                            <div class="form-group full-width">
                                <label>Condizioni note</label>
                                <input type="text" id="newPetKnownConditions" placeholder="Es: insuff. renale, artrosi, allergie...">
                            </div>
                            <div class="form-group full-width">
                                <label>Farmaci attuali</label>
                                <input type="text" id="newPetCurrentMeds" placeholder="Farmaci in corso (opzionale)">
                            </div>
                            <div class="form-group full-width">
                                <label>Note comportamentali</label>
                                <input type="text" id="newPetBehaviorNotes" placeholder="Es: paure, ansia, aggressivit√†...">
                            </div>
                            <div class="form-group">
                                <label>Localit√† (opz.)</label>
                                <input type="text" id="newPetLocation" placeholder="Es: Milano">
                            </div>
                        </div>
                    </div>
                    
                    <div class="button-row" style="margin-top: 20px;">
                        <button class="btn btn-success" onclick="saveNewPet()" data-testid="save-new-pet-button">üíæ Salva Nuovo Pet</button>
                        <button class="btn btn-danger" onclick="cancelAddPet()" data-testid="cancel-add-pet-button">‚ùå Annulla</button>
                        <button id="btnTestAddPet" class="btn btn-secondary" onclick="testFillAddPet()" style="display:none;">üß™ Test</button>
                    </div>
                </div>
            </div>

            <!-- Page: Photos -->
            <div id="page-photos" class="page">
                <div class="page-header">
                    <h2>üì∑ Foto</h2>

                </div>
                <div class="card">
                    <div class="button-row">
                        <button class="btn btn-primary" onclick="document.getElementById('photoInput').click()" data-testid="add-photo-button">üìÅ Aggiungi foto</button>
                        <button class="btn btn-secondary" onclick="capturePhoto()" data-testid="capture-photo-button">üì∏ Scatta foto</button>
                        <button id="btnTestPhotos" class="btn btn-secondary" onclick="testFillPhotos()" style="display:none;">üß™ Test</button>
                        <input type="file" id="photoInput" accept="image/*" multiple style="display:none" onchange="addPhotos(event)">
                    </div>
                    <div id="photoGrid" class="photo-grid"></div>
                </div>
            </div>

            <!-- Page: Vitals -->
            <div id="page-vitals" class="page">
                <div class="page-header">
                    <h2>üìä Parametri Vitali</h2>

                </div>
                <div class="card">
                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label>Data/Ora rilevazione</label>
                            <input type="datetime-local" id="vitalDateTime">
                        </div>
                        <div class="form-group">
                            <label>Peso (kg)</label>
                            <input type="number" id="vitalWeight" step="0.1" placeholder="Peso">
                        </div>
                        <div class="form-group">
                            <label>Temperatura (¬∞C)</label>
                            <input type="number" id="vitalTemp" step="0.1" placeholder="Temp">
                        </div>
                        <div class="form-group">
                            <label>Freq. Cardiaca (bpm)</label>
                            <input type="number" id="vitalHR" placeholder="FC">
                        </div>
                        <div class="form-group">
                            <label>Freq. Respiratoria</label>
                            <input type="number" id="vitalRR" placeholder="FR">
                        </div>
                        <div class="form-group">
                            <label>BCS (1-9)</label>
                            <select id="vitalBCS">
                                <option value="">-</option>
                                <option value="1">1 - Emaciato</option>
                                <option value="2">2 - Molto magro</option>
                                <option value="3">3 - Magro</option>
                                <option value="4">4 - Sottopeso</option>
                                <option value="5">5 - Ideale</option>
                                <option value="6">6 - Sovrappeso</option>
                                <option value="7">7 - Pesante</option>
                                <option value="8">8 - Obeso</option>
                                <option value="9">9 - Gravemente obeso</option>
                            </select>
                        </div>
                    </div>
                    <div class="button-row" style="margin-top: 10px;">
                        <button class="btn btn-success" onclick="recordVitals()" data-testid="record-vitals-button">üìä Registra</button>
                        <button class="btn btn-danger" onclick="resetVitals()" data-testid="reset-vitals-button">üßπ Azzera</button>
                        <button id="btnTestVitals" class="btn btn-secondary" onclick="testFillVitals()" style="display:none;">üß™ Test</button>
                    </div>
                    
                    <h3 style="margin-top: 20px;">Storico</h3>
                    <div class="chart-container">
                        <canvas id="vitalsChart"></canvas>
                    </div>
                    <div id="vitalsList" class="vitals-list"></div>
                </div>
            </div>

            <!-- Page: Diary -->
            <div id="page-diary" class="page">
                <div class="page-header">
                    <h2>üìî Profilo sanitario</h2>

                </div>
                <div class="card">
                    <div class="lang-selector" id="diaryLangSelector">
                        <button class="lang-btn" data-lang="IT" data-testid="diary-lang-it-button">IT</button>
                        <button class="lang-btn" data-lang="EN" data-testid="diary-lang-en-button">EN</button>
                        <button class="lang-btn" data-lang="DE" data-testid="diary-lang-de-button">DE</button>
                        <button class="lang-btn" data-lang="FR" data-testid="diary-lang-fr-button">FR</button>
                        <button class="lang-btn" data-lang="ES" data-testid="diary-lang-es-button">ES</button>
                    </div>
                    
                    <div class="textarea-wrapper">
                        <textarea id="diaryText" rows="15" placeholder="Profilo sanitario del paziente..."></textarea>
                        <button class="expand-btn" onclick="expandTextarea('diaryText', 'Profilo sanitario')" data-testid="expand-diary-button">‚õ∂</button>
                    </div>

                    <div class="button-row" style="margin-top: 15px;">
                        <button id="btnSpeakDiary" class="btn btn-secondary" onclick="speakDiary()" data-testid="speak-diary-button">üîä Leggi</button>
                        <button id="btnGenerateDiary" class="btn btn-primary" onclick="generateDiary()" data-testid="generate-diary-button">ü§ñ Genera</button>
                        <button id="btnSaveDiary" class="btn btn-success" onclick="saveDiary()" data-testid="save-diary-button">üíæ Salva</button>
                        <button id="btnExportDiaryTXT" class="btn btn-secondary" onclick="exportDiaryTXT()" data-testid="export-diary-txt-button">üìÑ TXT</button>
                        <button id="btnExportDiaryPDF" class="btn btn-secondary" onclick="exportDiaryPDF()" data-testid="export-diary-pdf-button">üìë PDF</button>
                    </div>
                </div>
            </div>

            <!-- Page: Q&A HUB -->
            <div id="page-qna" class="page">
                <div class="page-header">
                    <h2>‚ùì Domande & Risposte</h2>

                </div>
                <div class="card">
                    <p style="color:#666; margin-top:6px;">Scegli cosa vuoi fare:</p>
                    <div class="hub-grid">
                        <div class="hub-tile" onclick="navigateToPage('qna-report')">
                            <div class="hub-emoji">üìã</div>
                            <div class="hub-title">Domande su documento</div>
                            <div class="hub-sub">Apri o genera la spiegazione del documento da archivio</div>
                        </div>
                        <div class="hub-tile" onclick="navigateToPage('qna-pet')">
                            <div class="hub-emoji">üêæ</div>
                            <div class="hub-title">Domande sul tuo pet</div>
                            <div class="hub-sub">Fai una domanda e ottieni una risposta</div>
                        </div>
                        <div class="hub-tile" onclick="navigateToPage('tips')">
                            <div class="hub-emoji">üí°</div>
                            <div class="hub-title">Tips & Tricks</div>
                            <div class="hub-sub">Consigli personalizzati per il tuo pet</div>
                        </div>
                    </div>
                    <!-- Promo slot: faq_view (PR 3) -->
                    <div id="qna-promo-container"></div>
                </div>
            </div>

            <!-- Page: Q&A Pet -->
            <div id="page-qna-pet" class="page">
                <div class="page-header">
                    <h2>üêæ Domande sul pet</h2>

                </div>
                <div class="card">
                    <button id="btnAskQuestion" class="btn btn-primary" onclick="toggleQuestionRecording()" data-testid="ask-question-button">üé§ Chiedi</button>
                    <div class="textarea-wrapper" style="margin-top: 10px;">
                        <textarea id="qnaQuestion" rows="3" placeholder="La tua domanda..."></textarea>
                        <button class="expand-btn" onclick="expandTextarea('qnaQuestion', 'Domanda')" data-testid="expand-qna-question-button">‚õ∂</button>
                    </div>
                    
                    <h3 style="margin-top: 20px;">Risposta</h3>
                    <div class="textarea-wrapper">
                        <textarea id="qnaAnswer" rows="6" placeholder="La risposta apparir√† qui..." readonly></textarea>
                        <button class="expand-btn" onclick="expandTextarea('qnaAnswer', 'Risposta')" data-testid="expand-qna-answer-button">‚õ∂</button>
                    </div>
                    <div class="button-row" style="margin-top: 10px;">
                        <button class="btn btn-primary" onclick="generateQnAAnswer()" data-testid="generate-qna-answer-button">üí¨ Rispondi</button>
                        <button id="btnSpeakQnA" class="btn btn-secondary" onclick="speakQnAAnswer()" data-testid="speak-qna-button">üîä Leggi</button>
                    </div>
                    
                    <h3 style="margin-top: 20px;">Ti suggerisco io qualche domanda?</h3>
                    <button class="btn btn-secondary" onclick="generateQnAFaq()" data-testid="generate-qna-faq-button">üí° Genera suggerimenti</button>
                    <div id="qnaFaqList" class="faq-list"></div>
                </div>
            </div>

            <!-- Page: Q&A Report -->
            <div id="page-qna-report" class="page">
                <div class="page-header">
                    <h2>üìã Domande su documento</h2>

                </div>
                <div class="card">
                    <h3>Seleziona un documento dall'archivio</h3>
                    <div class="form-group" style="margin-top:10px;">
                        <label>Documento</label>
                        <select id="qnaReportSelect">
                            <option value="">-- Seleziona --</option>
                        </select>
                        <p style="font-size:12px;color:#888;margin-top:6px;">Suggerimento: se la spiegazione del documento √® gi√† presente nel record, verr√† riaperta senza rigenerarla.</p>
                    </div>
                    <div class="button-row" style="margin-top: 10px;">
                        <button class="btn btn-primary" onclick="openOrGenerateOwnerFromSelectedReport()" data-testid="open-owner-from-report-button">üìñ Spiegami il documento</button>
                        <button class="btn btn-secondary" onclick="navigateToPage('history')" data-testid="go-to-history-button">üìÅ Vai all'Archivio Sanitario</button>
                    </div>
                </div>
            </div>

            <!-- Page: Tips -->
            <div id="page-tips" class="page">
                <div class="page-header">
                    <h2>üí° Tips & Tricks</h2>
                    <div id="tipsMeta" class="tips-meta" data-testid="tips-meta"></div>

                </div>
                <div class="card">
                    <div class="button-row">
                        <button class="btn btn-primary" onclick="generateTipsTricks()" data-testid="generate-tips-button">üîÑ Genera</button>
                        <button class="btn btn-danger" onclick="resetTipsMemory()" title="Reset memoria Tips per questo pet" data-testid="reset-tips-button">‚ü≤ Ricomincia</button>
                        <button id="btnSpeakTips" class="btn btn-secondary" onclick="speakTips()" data-testid="speak-tips-button">üîä Leggi</button>
                    </div>
                    <div id="tipsTricksList" class="tips-list">
                        <p style="color: #888; text-align: center; padding: 40px;">Premi "Genera" per ricevere consigli personalizzati per il tuo pet</p>
                    </div>
                </div>
            </div>

            <!-- Page: Nutrition (Vet + Owner dedicated page) -->
            <div id="page-nutrition" class="page">
                <div class="page-header">
                    <h2>ü•ó Nutrizione</h2>
                </div>
                <div class="card">
                    <!-- Container per il piano corrente (validato o pending) -->
                    <div id="nutrition-page-current"></div>

                    <!-- Container per la generazione -->
                    <div id="nutrition-page-generate"></div>

                    <!-- Container per lo storico piani -->
                    <div id="nutrition-page-history"></div>

                    <!-- Container per il metodo di calcolo -->
                    <div id="nutrition-page-method"></div>
                </div>
            </div>

            <!-- Page: History -->
            <div id="page-history" class="page">
                <div class="page-header">
                    <h2>üìÅ Archivio Sanitario</h2>

                </div>
                <div class="card">
                    <div class="button-row" style="margin-bottom:15px;">
                        <button class="btn btn-primary" onclick="triggerDocumentUpload()" data-testid="upload-document-button">üìÑ Carica Documento</button>
                        <input type="file" id="documentFileInput" accept=".pdf,.jpg,.jpeg,.png,.webp" style="display:none" onchange="handleDocumentUpload(event)">
                    </div>
                    <div id="documentUploadLoader"></div>
                    <div id="historyList" class="history-list"></div>
                    <p class="history-note">Nota: tieni premuto un referto per mostrare la "x" e cancellarlo.</p>
                </div>
                <div id="pet-conversations-section" style="margin-top: 24px;">
                    <h3 style="font-size: 16px; color: #1e3a5f; margin-bottom: 12px;">üí¨ Conversazioni relative a questo pet</h3>
                    <div id="pet-conversations-list"></div>
                </div>
            </div>

            <!-- Page: Medications -->
            <div id="page-medications" class="page">
                <div class="page-header">
                    <h2>üíä Farmaci</h2>

                </div>
                <div class="card">
                    <button class="btn btn-primary" onclick="openMedicationModal()" data-testid="add-medication-button">+ Aggiungi Farmaco</button>
                    <button id="btnSpeakMeds" class="btn btn-secondary" onclick="speakMedications()" data-testid="speak-medications-button">üîä Leggi Farmaci</button>
                    <button id="btnTestMeds" class="btn btn-secondary" onclick="testFillMedications()" style="display:none;">üß™ Test</button>
                    <div id="medicationList" class="medication-list"></div>
                </div>
            </div>

            <!-- Page: Appointment (REMOVED - PR 3) ‚Äî redirect to home -->

            <!-- Page: Document viewer (PR 8) -->
            <div id="page-document" class="page">
                <div class="page-header">
                    <h2 id="documentTitle">üìÑ Documento</h2>
                </div>
                <div class="card">
                    <div id="documentViewer" style="min-height:200px; text-align:center; color:#888;">
                        Seleziona un documento dall'Archivio Sanitario.
                    </div>
                    <div id="documentMeta" style="margin-top:10px; font-size:12px; color:#888;"></div>
                    <div id="documentAiContainer" style="margin-top:15px;"></div>
                    <div class="button-row" style="margin-top:15px;">
                        <button id="btnDocRead" class="btn btn-primary" onclick="readDocument()" disabled data-testid="doc-read-button">üîç Trascrivi</button>
                        <button id="btnDocExplain" class="btn btn-secondary" onclick="explainDocument()" disabled data-testid="doc-explain-button">üí¨ Spiegami il documento</button>
                    </div>
                    <div id="documentReadResult" style="margin-top:15px; display:none;">
                        <h3>Testo trascritto</h3>
                        <div id="documentReadContent" class="card" style="background:#f9f9f9;"></div>
                    </div>
                </div>
            </div>

            <!-- Page: Settings -->
            <div id="page-settings" class="page">
                <div class="page-header">
                    <h2>‚öôÔ∏è Impostazioni</h2>

                </div>
                <!-- Account Info Card (visible to all users) -->
                <div class="card" id="settingsAccountCard" data-testid="account-info-card">
                    <h3>Il mio Account</h3>
                    <div style="display:grid; grid-template-columns:auto 1fr; gap:6px 12px; margin-bottom:12px; font-size:14px;">
                        <span style="color:#888;">Email:</span>
                        <span id="accountEmail" style="font-weight:500;">‚Äî</span>
                        <span style="color:#888;">Nome:</span>
                        <span id="accountDisplayName" style="font-weight:500;">‚Äî</span>
                        <div id="accountNameEditRow" style="display:none; grid-column:1/-1;">
                            <label style="color:#888; font-size:13px;">Nome veterinario:</label>
                            <div style="display:flex; gap:8px; align-items:center; margin-top:4px;">
                                <input type="text" id="vetNameFallbackInput" placeholder="Inserisci il tuo nome" style="flex:1; padding:6px 10px; border:1px solid #ddd; border-radius:6px; font-size:14px;" data-testid="vet-name-fallback-input">
                                <button class="btn btn-secondary" onclick="saveVetNameFromAccount()" style="padding:6px 12px; font-size:13px;" data-testid="save-vet-name-button">Salva</button>
                            </div>
                        </div>
                        <span style="color:#888;">Ruolo:</span>
                        <span id="accountRole" style="font-weight:500;">‚Äî</span>
                        <span id="accountTenantRow" style="color:#888; display:none;">Tenant:</span>
                        <span id="accountTenant" style="font-weight:500; display:none;">‚Äî</span>
                    </div>
                    <button class="btn btn-secondary" onclick="openChangePasswordModal()" data-testid="change-password-button">üîí Cambia Password</button>
                </div>

                <!-- Consent banner (PR 3) ‚Äî after account card -->
                <div id="settings-consent-container"></div>

                <div class="card" id="settingsSpeakersCard">
                    <button class="section-toggle" onclick="toggleSpeakersSection()" data-testid="toggle-speakers-section-button">
                        <span>üé§ Parlanti (Reference Clips)</span>
                        <span id="speakersToggleIcon" class="toggle-icon">‚ñ∏</span>
                    </button>
                    <div id="speakersSectionBody" style="display:none;">
                    <p style="color:#666;font-size:13px;margin-bottom:15px;">
                        Configura i parlanti con nome e ruolo. Le clip audio (2-10s) migliorano l'identificazione vocale.
                    </p>

                    <div id="speakersContainer" class="speakers-section"></div>

                    <button id="btnAddSpeaker" class="btn btn-primary" onclick="addNewSpeaker()" style="margin-top:15px;" data-testid="add-speaker-button">
                        ‚ûï Aggiungi Parlante (max 4)
                    </button>
                    </div>
                </div>

                <div class="card" id="settingsClinicCard">
                    <h3>Informazioni clinica</h3>
                    <button class="section-toggle" onclick="toggleClinicLogoSection()" data-testid="toggle-clinic-logo-section-button">
                        <span>Logo clinica</span>
                        <span id="clinicLogoToggleIcon" class="toggle-icon">‚ñ∏</span>
                    </button>
                    <div id="clinicLogoSectionBody" style="display:none;">
                        <p style="color:#666;font-size:13px;margin-bottom:10px;">
                            Carica il logo che comparir√† nell'intestazione delle pagine e nei PDF esportati.
                        </p>
                        <div class="clinic-logo-upload">
                            <img id="clinicLogoPreview" src="logo-anicura.png" alt="Logo clinica" class="clinic-logo-preview" data-testid="clinic-logo-preview">
                            <div class="button-row">
                                <label class="btn btn-secondary" data-testid="clinic-logo-upload-button">
                                    üì§ Carica logo
                                    <input type="file" id="clinicLogoInput" accept="image/*" style="display:none;" data-testid="clinic-logo-input">
                                </label>
                                <button class="btn btn-secondary" onclick="resetClinicLogo()" data-testid="reset-clinic-logo-button">‚Ü©Ô∏è Ripristina</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Communication Settings -->
                <div class="card" id="settingsAiCommCard">
                    <h3>La tua assistente ADA & Comunicazione</h3>
                    <div id="ai-settings-container" data-testid="ai-settings-container"></div>
                </div>

                <!-- OpenAI Optimizations (super_admin only) -->
                <div id="openaiOptCard" class="card" style="display:none;">
                    <h3>OpenAI ‚Äî Ottimizzazioni</h3>
                    <p style="color:#666;font-size:13px;margin-bottom:15px;">
                        Quando attive, i task secondari (traduzioni, tips, FAQ, glossario, spiegazione proprietario)
                        usano un modello pi√π economico. Il SOAP resta invariato.
                    </p>
                    <div class="form-group" style="margin-bottom:15px;">
                        <label style="display:flex;align-items:center;gap:10px;">
                            <input type="checkbox" id="openaiOptEnabled">
                            <span>Ottimizzazioni globali attive</span>
                        </label>
                    </div>
                    <div class="form-group" style="margin-bottom:15px;">
                        <label style="display:flex;align-items:center;gap:10px;">
                            <input type="checkbox" id="openaiOptSmartDiarization">
                            <span>Diarizzazione solo quando serve</span>
                        </label>
                        <p style="font-size:12px;color:#888;margin-top:5px;">
                            Se attiva e nessun parlante √® configurato, salta la diarizzazione (Whisper diretto, pi√π veloce ed economico).
                        </p>
                    </div>
                    <button class="btn btn-primary" onclick="saveOpenAiOptimizations()">Salva</button>
                </div>

                <div class="card" id="settingsSystemCard">
                    <h3>Sistema</h3>
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="debugLogEnabled" onchange="toggleDebugLog(this.checked)" checked>
                            <span>Debug attivo (per i test)</span>
                        </label>
                        <p style="font-size: 12px; color: #888; margin-top: 5px;">Disattiva per migliorare le performance in produzione</p>
                    </div>

                    <h3 style="margin-top: 20px;">Informazioni</h3>
                        <p><strong>Versione:</strong> ADA v<span id="appVersion">--</span></p>
                    <p><strong>Novit√† v<span id="appReleaseNotesVersion">--</span>:</strong> <span id="appReleaseNotesText">Caricamento...</span></p>
                </div>
            </div>

            <!-- Page: Communication (Unified messaging: human + AI) -->
            <div id="page-communication" class="page">
                <div class="page-header">
                    <h2>üí¨ Messaggi</h2>
                </div>
                <div id="communication-container" data-testid="communication-container"></div>
            </div>

            <!-- Page: Admin Dashboard (PR 4) -->
            <div id="page-admin-dashboard" class="page">
                <div class="page-header" style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
                    <h2 style="margin:0;">Dashboard Promo</h2>
                    <button class="btn btn-danger" style="font-size:12px;" onclick="adminDeleteAllDashboardData()">üóëÔ∏è Cancella tutti gli eventi</button>
                </div>
                <div class="card">
                    <div id="admin-dashboard-content"></div>
                </div>
            </div>

            <!-- Page: Admin Catalog (PR 4) -->
            <div id="page-admin-catalog" class="page">
                <div class="page-header">
                    <h2>Catalogo Prodotti</h2>
                </div>
                <div class="card">
                    <p style="color:#666;margin-bottom:20px;">Gestisci i prodotti promozionali dal pannello admin.</p>
                    <div id="catalog-tenant-selector"></div>
                    <div id="admin-catalog-content"></div>
                </div>
            </div>

            <!-- Page: Admin Campaigns (PR 4) -->
            <div id="page-admin-campaigns" class="page">
                <div class="page-header">
                    <h2>Campagne</h2>
                </div>
                <div class="card">
                    <p style="color:#666;margin-bottom:20px;">Gestisci le campagne promozionali.</p>
                    <div id="campaigns-tenant-selector"></div>
                    <div id="admin-campaigns-content"></div>
                </div>
            </div>

            <!-- Page: Admin Wizard (PR 4) -->
            <div id="page-admin-wizard" class="page">
                <div class="page-header">
                    <h2>Importa file</h2>
                </div>
                <div class="card">
                    <div id="admin-wizard-content"></div>
                </div>
            </div>

            <!-- Page: Super Admin Gestione Hub -->
            <div id="page-superadmin-gestione" class="page">
                <div class="page-header">
                    <h2>üîß Gestione</h2>
                </div>
                <div class="card" style="max-width:500px;">
                    <div style="display:flex;flex-direction:column;gap:12px;">
                        <button class="btn btn-primary" style="padding:14px 20px;font-size:15px;display:flex;align-items:center;gap:10px;" onclick="navigateToPage('superadmin-users')">üë• Gestione Utenti</button>
                        <button class="btn btn-primary" style="padding:14px 20px;font-size:15px;display:flex;align-items:center;gap:10px;" onclick="navigateToPage('superadmin-tenants')">üè¢ Gestione Tenant</button>
                        <button class="btn btn-primary" style="padding:14px 20px;font-size:15px;display:flex;align-items:center;gap:10px;" onclick="navigateToPage('superadmin-policies')">üìã Policies</button>
                        <button class="btn btn-primary" style="padding:14px 20px;font-size:15px;display:flex;align-items:center;gap:10px;" onclick="navigateToPage('superadmin-tags')">üè∑Ô∏è Tag Dictionary</button>
                        <button class="btn btn-primary" style="padding:14px 20px;font-size:15px;display:flex;align-items:center;gap:10px;" onclick="navigateToPage('superadmin-sources')">üí° Fonti Tips</button>
                    </div>
                </div>
            </div>

            <!-- Page: Super Admin Tenants -->
            <div id="page-superadmin-tenants" class="page">
                <div class="page-header">
                    <h2>Gestione Tenant</h2>
                </div>
                <div class="card">
                    <div id="superadmin-tenants-content"></div>
                </div>
            </div>

            <!-- Page: Super Admin Users (PR user-mgmt) -->
            <div id="page-superadmin-users" class="page">
                <div class="page-header">
                    <h2>Gestione Utenti</h2>
                </div>
                <div class="card">
                    <div id="superadmin-users-content"></div>
                </div>
            </div>

            <!-- Page: Super Admin Policies -->
            <div id="page-superadmin-policies" class="page">
                <div class="page-header">
                    <h2>Policies</h2>
                </div>
                <div class="card">
                    <div id="superadmin-policies-content"></div>
                </div>
            </div>

            <!-- Page: Super Admin Tags -->
            <div id="page-superadmin-tags" class="page">
                <div class="page-header">
                    <h2>Tag Dictionary</h2>
                </div>
                <div class="card">
                    <div id="superadmin-tags-content"></div>
                </div>
            </div>

            <!-- Page: Super Admin Audit Log -->
            <div id="page-superadmin-audit" class="page">
                <div class="page-header">
                    <h2>Audit Log</h2>
                </div>
                <div class="card">
                    <div id="superadmin-audit-content"></div>
                </div>
            </div>

            <!-- Page: Super Admin Tips Sources -->
            <div id="page-superadmin-sources" class="page">
                <div class="page-header">
                    <h2>Gestione Fonti Tips & Tricks</h2>
                </div>
                <div class="card">
                    <div id="superadmin-sources-content"></div>
                </div>
            </div>

            <!-- Page: Debug -->
            <div id="page-debug" class="page" style="display:none;">
                <div class="page-header">
                    <h2>üõ† Debug</h2>
                </div>
                <!-- Audit Log button moved to debug-system-tools card -->
                <div class="card" style="margin-bottom:15px;">
                    <div id="roleToggleLabelBlock" style="margin-bottom:8px;">
                        <label style="font-weight:600; display:block;">Ruolo attivo</label>
                    </div>
                    <div id="roleToggleContainer" class="role-toggle-container">
                        <button id="roleToggleBtn" class="role-toggle-btn" onclick="toggleActiveRole()" data-testid="role-toggle-button">
                            <span id="roleToggleIcon">ü©∫</span>
                            <span id="roleToggleLabel">Veterinario</span>
                        </button>
                    </div>
                    <div id="superAdminRoleSelector" style="display:none; margin-top:10px;">
                        <div style="display:flex;flex-wrap:wrap;gap:10px;margin-top:4px;">
                            <label style="display:flex;align-items:center;gap:4px;font-size:14px;cursor:pointer;">
                                <input type="checkbox" id="saRoleVetInt" value="vet_int" onchange="onSuperAdminRoleToggle()"> ü©∫ Vet Interno
                            </label>
                            <label style="display:flex;align-items:center;gap:4px;font-size:14px;cursor:pointer;">
                                <input type="checkbox" id="saRoleVetExt" value="vet_ext" onchange="onSuperAdminRoleToggle()"> üîó Vet Esterno
                            </label>
                            <label style="display:flex;align-items:center;gap:4px;font-size:14px;cursor:pointer;">
                                <input type="checkbox" id="saRoleOwner" value="proprietario" onchange="onSuperAdminRoleToggle()"> üêæ Proprietario
                            </label>
                            <label style="display:flex;align-items:center;gap:4px;font-size:14px;cursor:pointer;">
                                <input type="checkbox" id="saRoleAdmin" value="admin_brand" onchange="onSuperAdminRoleToggle()"> üìä Admin Brand
                            </label>
                            <label style="display:flex;align-items:center;gap:4px;font-size:14px;cursor:pointer;">
                                <input type="checkbox" id="saRoleSA" value="super_admin" onchange="onSuperAdminRoleToggle()"> ‚ö° Super Admin
                            </label>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <button class="section-toggle" onclick="toggleChunkingSection()" data-testid="toggle-chunking-section-button">
                        <span>üéöÔ∏è Registrazione a chunk (robusta)</span>
                        <span id="chunkingToggleIcon" class="toggle-icon">‚ñ∏</span>
                    </button>
                    <div id="chunkingSectionBody" style="display:none;" data-testid="chunking-section-body">
                        <p style="color:#666;font-size:13px;margin-bottom:10px;">
                            Default consigliati: Windows 20 min ‚Ä¢ Android 15 min ‚Ä¢ iPhone 10 min. Il profilo viene scelto automaticamente e mostrato qui.
                        </p>

                        <div class="form-group" style="margin-bottom: 12px;">
                            <label style="display:flex;align-items:center;gap:10px;">
                                <input type="checkbox" id="chunkingEnabled" onchange="toggleChunkingEnabled(this.checked)" data-testid="chunking-enabled-toggle">
                                <span>Abilita registrazione a chunk (consigliata)</span>
                            </label>
                        </div>

                        <div class="form-grid" style="grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div class="form-group">
                                <label>Profilo in uso (auto)</label>
                                <input type="text" id="chunkingProfile" readonly data-testid="chunking-profile">
                            </div>
                            <div class="form-group">
                                <label>mimeType attivo (auto)</label>
                                <input type="text" id="chunkingMimeType" readonly data-testid="chunking-mimetype">
                            </div>
                            <div class="form-group">
                                <label>chunkDurationSec</label>
                                <input type="number" id="chunkDurationSec" min="60" step="10" data-testid="chunk-duration-input">
                            </div>
                            <div class="form-group">
                                <label>timesliceMs</label>
                                <input type="number" id="timesliceMs" min="250" step="50" data-testid="chunk-timeslice-input">
                            </div>
                            <div class="form-group">
                                <label>maxPendingChunks</label>
                                <input type="number" id="maxPendingChunks" min="1" step="1" data-testid="chunk-max-pending-input">
                            </div>
                            <div class="form-group">
                                <label>maxConcurrentTranscriptions</label>
                                <input type="number" id="maxConcurrentTranscriptions" min="1" step="1" data-testid="chunk-max-concurrent-input">
                            </div>
                            <div class="form-group">
                                <label>uploadRetryCount</label>
                                <input type="number" id="uploadRetryCount" min="0" step="1" data-testid="chunk-retry-count-input">
                            </div>
                            <div class="form-group">
                                <label>uploadRetryBackoffMs</label>
                                <input type="number" id="uploadRetryBackoffMs" min="200" step="100" data-testid="chunk-retry-backoff-input">
                            </div>
                            <div class="form-group">
                                <label>hardStopAtMb</label>
                                <input type="number" id="hardStopAtMb" min="1" step="1" data-testid="chunk-hard-stop-input">
                            </div>
                            <div class="form-group">
                                <label>warnBeforeSplitSec</label>
                                <input type="number" id="warnBeforeSplitSec" min="0" step="1" data-testid="chunk-warn-before-input">
                            </div>
                            <div class="form-group full-width">
                                <label>autoSplitGraceMs</label>
                                <input type="number" id="autoSplitGraceMs" min="0" step="50" data-testid="chunk-split-grace-input">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card" data-testid="debug-system-tools">
                    <div style="display:flex; flex-wrap:wrap; gap:8px;">
                        <button class="btn btn-primary" onclick="openCostsPage()" data-testid="open-costs-button">üí∞ Consumo API</button>
                        <button class="btn btn-secondary" onclick="showApiMetrics()">üì° Metriche API</button>
                        <button class="btn btn-secondary" id="debug-audit-btn" style="display:none;" onclick="navigateToPage('superadmin-audit')">üìã Audit Log</button>
                        <button class="btn btn-secondary" onclick="exportLogFile()" data-testid="export-log-button">üìÑ Scarica ADA.log</button>
                        <button class="btn btn-secondary" onclick="clearLog(); showToast('Log cancellato', 'success');" data-testid="clear-log-button">Cancella ADA.log</button>
                    </div>
                </div>
                <div class="card" style="margin-bottom:15px;">
                    <label style="display:flex;align-items:center;gap:10px;cursor:pointer;">
                        <input type="checkbox" id="debugForceMultiService" onchange="toggleDebugForceMultiService(this.checked)">
                        <span style="font-weight:600;">Visualizza sempre multi-servizio</span>
                    </label>
                    <p style="font-size:11px;color:#888;margin-top:6px;">
                        Se attivo, mostra sempre i blocchi Nutrizione e Assicurazione nelle pagine in cui si possono attivare, indipendentemente da ruolo, policy o configurazione prodotto.
                    </p>
                </div>
                <div id="debugTestTools" class="card" style="display:none;">
                    <p style="margin: 0 0 10px; color: #666; font-size: 12px;">üß™ Strumenti di test (debug)</p>
                    <div class="button-row">
                        <button class="btn btn-secondary" onclick="triggerLongAudioTestUpload()" data-testid="long-audio-test-button">üß™ Carica audio lungo</button>
                        <button class="btn btn-secondary" onclick="triggerLongTextTestUpload()" data-testid="long-text-test-button">üß™ Carica testo lungo</button>
                    </div>
                    <input type="file" id="longAudioTestInput" accept="audio/*,.webm,.mp3,.wav,.m4a,.mp4,.ogg" style="display:none" onchange="handleLongAudioTestUpload(event)">
                    <input type="file" id="longTextTestInput" accept=".txt,.text" style="display:none" onchange="handleLongTextTestUpload(event)">
                    <p style="font-size: 11px; color: #888; margin-top: 6px;">Audio test: processa il file come se fossero chunk. Testo test: simula arrivo incrementale per stressare append/persistenza.</p>
                </div>
                <div id="audioCacheTools" class="card" style="display:none;">
                    <p style="font-size: 12px; color: #666; margin: 0 0 8px;">Cache audio di test (salvata solo con Debug ON)</p>
                    <div class="button-row">
                        <button class="btn btn-secondary" onclick="exportSavedAudioChunks()" data-testid="export-saved-audio-chunks-button">üì¶ Esporta file audio</button>
                        <button class="btn btn-secondary" onclick="clearSavedAudioChunks()" data-testid="clear-saved-audio-chunks-button">üóëÔ∏è Cancella file audio</button>
                    </div>
                    <p id="audioCacheInfo" style="font-size: 12px; color: #888; margin-top: 6px;" data-testid="audio-cache-info"></p>
                </div>
            </div>

            <!-- Page: AI Pet Description -->
            <div id="page-ai-petdesc" class="page" style="display:none;">
                <div class="card" style="margin-bottom:16px;">
                    <h2 style="font-size:18px;color:#1e3a5f;margin-bottom:12px;">ü§ñ Descrizione Pet per AI</h2>
                    <p style="font-size:13px;color:#64748b;margin-bottom:16px;">
                        Questa descrizione viene generata automaticamente dall'AI a partire da tutti i dati del pet,
                        e viene usata per trovare il miglior match con i prodotti del catalogo.
                    </p>
                    <div style="margin-bottom:12px;">
                        <label style="font-size:12px;font-weight:600;color:#1e3a5f;display:block;margin-bottom:4px;">
                            Descrizione Pet (per AI matching)
                        </label>
                        <textarea id="aiPetDescriptionField" readonly
                            style="width:100%;min-height:300px;padding:12px;border:1px solid #e2e8f0;border-radius:8px;
                                   font-size:13px;line-height:1.6;resize:vertical;background:#f1f5f9;color:#334155;
                                   font-family:inherit;box-sizing:border-box;"
                            placeholder="Seleziona un pet per visualizzare la descrizione AI..."></textarea>
                    </div>
                    <div style="display:flex;gap:8px;align-items:center;">
                        <button type="button" class="btn btn-secondary" id="btnRegenerateAiDesc"
                            onclick="regenerateAiPetDescription()" style="font-size:13px;">
                            üîÑ Rigenera descrizione
                        </button>
                        <span id="aiDescStatus" style="font-size:12px;color:#94a3b8;"></span>
                    </div>
                    <div id="aiDescSources" style="margin-top:12px;font-size:11px;color:#94a3b8;"></div>
                </div>
            </div>

            <!-- Page: Seed Engine (PR 14) -->
            <div id="page-seed" class="page">
                <div class="page-header">
                    <h2>üå± Seed Engine</h2>
                </div>
                <!-- Card Modalit√† -->
                <div class="card" style="margin-bottom:15px;">
                    <label style="font-weight:600;display:block;margin-bottom:8px;">Modalit√†</label>
                    <label style="display:block;margin-bottom:6px;"><input type="radio" name="seedMode" value="fresh" checked> Da zero (cancella tutto prima)</label>
                    <label style="display:block;"><input type="radio" name="seedMode" value="append"> Aggiungi all'esistente</label>
                </div>
                <!-- Card Quantit√† -->
                <div class="card" style="margin-bottom:15px;">
                    <label style="font-weight:600;display:block;margin-bottom:8px;">Quantit√†</label>
                    <div class="form-grid" style="grid-template-columns:1fr 1fr;">
                        <div class="form-group"><label>Numero pet</label><input type="number" id="seedPetCount" value="10" min="1" max="100"></div>
                        <div class="form-group"><label>Referti SOAP per pet</label><input type="number" id="seedSoapPerPet" value="3" min="1" max="10"></div>
                        <div class="form-group"><label>Documenti per pet</label><input type="number" id="seedDocsPerPet" value="2" min="0" max="5"></div>
                        <div class="form-group"><label>Parametri vitali per pet</label><input type="number" id="seedVitalsPerPet" value="8" min="0" max="30"></div>
                        <div class="form-group"><label>Farmaci attivi per pet</label><input type="number" id="seedMedsPerPet" value="3" min="0" max="8"></div>
                        <div class="form-group"><label>Foto per pet</label><input type="number" id="seedPhotosPerPet" value="2" min="0" max="6"></div>
                        <div class="form-group"><label>Eventi promo per pet</label><input type="number" id="seedPromoEventsPerPet" value="5" min="0" max="20"></div>
                    </div>
                    <p id="seedEstimate" style="font-size:12px;color:#666;margin-top:8px;">~30 referti, ~20 documenti ‚Äî circa 5 minuti con OpenAI</p>
                </div>
                <!-- Card Distribuzione specie -->
                <div class="card" style="margin-bottom:15px;">
                    <label style="font-weight:600;display:block;margin-bottom:8px;">Distribuzione specie (%)</label>
                    <div class="form-grid" style="grid-template-columns:1fr 1fr 1fr;">
                        <div class="form-group"><label>Cani</label><input type="number" id="seedDogPct" value="60" min="0" max="100"></div>
                        <div class="form-group"><label>Gatti</label><input type="number" id="seedCatPct" value="30" min="0" max="100"></div>
                        <div class="form-group"><label>Conigli</label><input type="number" id="seedRabbitPct" value="10" min="0" max="100"></div>
                    </div>
                </div>
                <!-- Card Owner / Vet Ext opzionali -->
                <div class="card" style="margin-bottom:15px;">
                    <label style="font-weight:600;display:block;margin-bottom:8px;">Assegnazione pet (opzionale)</label>
                    <div class="form-grid" style="grid-template-columns:1fr 1fr;">
                        <div class="form-group">
                            <label>Proprietario (opzionale)</label>
                            <select id="seedOwnerUserId">
                                <option value="">‚Äî Casuale ‚Äî</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Vet Esterno / referral (opzionale)</label>
                            <select id="seedVetExtUserId">
                                <option value="">‚Äî Casuale ‚Äî</option>
                            </select>
                        </div>
                    </div>
                </div>
                <!-- Card Azioni -->
                <div class="card" style="margin-bottom:15px;">
                    <div style="display:flex;flex-wrap:wrap;gap:8px;">
                        <button class="btn btn-primary" id="seedStartBtn" onclick="seedStart()">üöÄ Avvia popolamento</button>
                        <button class="btn btn-danger" id="seedCancelBtn" onclick="seedCancel()" style="display:none;">‚èπ Annulla</button>
                        <button class="btn btn-secondary" onclick="seedWipe()">Cancella dati seed</button>
                        <button class="btn btn-danger" onclick="seedWipeAllMyPets()" style="font-size:12px;">Elimina TUTTI i miei pet</button>
                    </div>
                </div>
                <!-- Barra progresso -->
                <div id="seedProgressSection" class="card" style="display:none;margin-bottom:15px;">
                    <div id="seedProgressBar" class="progress-bar" style="height:20px;background:#e0e0e0;border-radius:10px;overflow:hidden;margin-bottom:8px;"><div class="progress-fill" style="height:100%;background:var(--primary);width:0%;transition:width 0.3s;"></div></div>
                    <p id="seedPhaseText" style="font-size:13px;color:#333;margin-bottom:8px;">In attesa...</p>
                    <pre id="seedLogArea" style="background:#f5f5f5;padding:10px;border-radius:6px;max-height:200px;overflow-y:auto;font-size:11px;white-space:pre-wrap;"></pre>
                </div>
                <!-- Card Promo (PR 15) -->
                <div class="card" style="margin-bottom:15px;">
                    <label style="font-weight:600;display:block;margin-bottom:8px;">üì¶ Popolamento Promo ‚Äî Brand e Prodotti</label>
                    <p style="font-size:12px;color:#666;margin-bottom:10px;">
                        Inserisci brand. ADA cercher√† i siti ufficiali e ti proporr√† i prodotti da importare.
                    </p>
                    <div style="display:flex;gap:8px;margin-bottom:10px;">
                        <input type="text" id="seedBrandInput" placeholder="es. Royal Canin, Hill's, Purina..." style="flex:1; padding:8px; border:1px solid #ddd; border-radius:6px; height:38px; box-sizing:border-box;">
                        <button class="btn btn-primary" onclick="seedSearchBrand()">üîç Cerca siti</button>
                    </div>
                    <div id="seedBrandResults" style="display:none;"></div>
                    <div style="margin-top:8px;display:flex;gap:8px;align-items:center;">
                        <input type="text" id="seedExtraSiteInput" placeholder="Aggiungi URL manualmente..." style="flex:1; padding:8px; border:1px solid #ddd; border-radius:6px; height:38px; box-sizing:border-box;">
                        <button class="btn btn-secondary" onclick="seedAddExtraSite()">‚ûï Aggiungi</button>
                    </div>
                    <div style="margin-top:8px;">
                        <label style="font-size:12px;font-weight:600;display:block;margin-bottom:4px;">
                            Carica siti da file TXT
                        </label>
                        <p style="font-size:11px;color:#888;margin:0 0 6px;">
                            ‚ÑπÔ∏è Il file deve contenere un URL per riga, senza intestazioni. Esempio:<br>
                            <code style="font-size:10px;">https://www.royalcanin.com<br>https://www.hillspet.it<br>https://www.purina.it</code>
                        </p>
                        <input type="file" id="seedSitesFileInput" accept=".txt" onchange="seedLoadSitesFromFile(event)">
                    </div>
                    <button class="btn btn-primary" id="seedScrapeBtn" onclick="seedScrapeSites()" style="display:none;margin-top:10px;">
                        üì• Estrai prodotti dai siti selezionati
                    </button>
                    <div id="seedScrapeResults" style="display:none;"></div>
                    <!-- Opzioni import (tenant + mode) ‚Äî mostrate dopo scraping -->
                    <div id="seedPromoOptions" style="display:none;margin-top:12px;padding:12px;background:#f8fafc;border-radius:8px;border:1px solid #e2e8f0;">
                        <div style="display:flex;gap:16px;flex-wrap:wrap;align-items:flex-end;">
                            <div>
                                <label style="font-size:12px;font-weight:600;display:block;margin-bottom:4px;">Tenant</label>
                                <select id="seedPromoTenant" style="padding:8px;border:1px solid #ddd;border-radius:6px;min-width:180px;"></select>
                            </div>
                            <div>
                                <label style="font-size:12px;font-weight:600;display:block;margin-bottom:4px;">Modalit√† import</label>
                                <label style="display:block;font-size:13px;"><input type="radio" name="seedPromoMode" value="replace"> Sostituisci importazione precedente</label>
                                <label style="display:block;font-size:13px;"><input type="radio" name="seedPromoMode" value="append" checked> Aggiungi all'esistente (append)</label>
                            </div>
                        </div>
                    </div>
                    <!-- Preview navigabile prodotti ‚Äî mostrata dopo scraping -->
                    <div id="seedPromoPreview" style="display:none;margin-top:12px;"></div>
                    <div style="margin-top:12px; padding-top:12px; border-top:1px solid #e2e8f0;">
                        <button class="btn btn-danger" onclick="seedResetPromoSection()">
                            üóëÔ∏è Azzera siti e prodotti proposti
                        </button>
                    </div>
                </div>
                <!-- Card Demo Mode -->
                <div class="card" style="margin-bottom:15px;">
                    <label style="font-weight:600;display:block;margin-bottom:8px;">üé≠ Demo Mode ‚Äî Generazione rapida multi-servizio</label>
                    <p style="font-size:12px;color:#666;margin-bottom:10px;">
                        Genera 3 pet demo complementari con dati promo, piani nutrizionali e proposte assicurative. Ideale per dimostrazioni.
                    </p>
                    <div style="display:flex;gap:16px;flex-wrap:wrap;align-items:flex-end;margin-bottom:12px;">
                        <div>
                            <label style="font-size:12px;font-weight:600;display:block;margin-bottom:4px;">Tenant</label>
                            <select id="seedDemoTenant" style="padding:8px;border:1px solid #ddd;border-radius:6px;min-width:180px;" onfocus="seedLoadDemoTenants()">
                                <option value="">‚Äî Seleziona tenant ‚Äî</option>
                            </select>
                        </div>
                    </div>
                    <div style="margin-bottom:12px;">
                        <label style="font-size:12px;font-weight:600;display:block;margin-bottom:6px;">Servizi da attivare</label>
                        <label style="display:inline-flex;align-items:center;gap:4px;margin-right:16px;font-size:13px;">
                            <input type="checkbox" id="seedDemoPromo" checked> Promo
                        </label>
                        <label style="display:inline-flex;align-items:center;gap:4px;margin-right:16px;font-size:13px;">
                            <input type="checkbox" id="seedDemoNutrition" checked> Nutrizione
                        </label>
                        <label style="display:inline-flex;align-items:center;gap:4px;font-size:13px;">
                            <input type="checkbox" id="seedDemoInsurance" checked> Assicurazione
                        </label>
                    </div>
                    <button class="btn btn-primary" onclick="seedStartDemo()">üé≠ Avvia Demo</button>
                </div>
            </div>

            <!-- Page: Costs -->
            <div id="page-costs" class="page">
                <div class="page-header">
                    <h2>üí∞ Consumo API</h2>

                </div>
                <div class="card">
                    <div id="costList" class="cost-list" data-testid="cost-list"></div>
                    <div class="cost-total-box">
                        <span>TOTALE STIMATO</span>
                        <span id="totalCost" class="cost-total-amount" data-testid="total-cost">$ 0.00</span>
                    </div>
                    <p id="lastResetInfo" class="last-reset-info" data-testid="last-reset-info">Ultimo azzeramento: mai</p>
                    <button class="btn btn-danger" onclick="resetCosts()" data-testid="reset-costs-button">üîÑ Azzera contatori</button>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal: Medication -->
    <div id="medicationModal" class="modal">
        <div class="modal-content">
            <h3 id="medicationModalTitle">Aggiungi Farmaco</h3>
            <div class="form-group">
                <label>Nome farmaco</label>
                <input type="text" id="medName" placeholder="Nome">
            </div>
            <div class="form-group">
                <label>Dosaggio</label>
                <input type="text" id="medDosage" placeholder="Es: 5mg">
            </div>
            <div class="form-group">
                <label>Frequenza</label>
                <input type="text" id="medFrequency" placeholder="Es: BID, q12h">
            </div>
            <div class="form-group">
                <label>Durata</label>
                <input type="text" id="medDuration" placeholder="Es: 7 giorni">
            </div>
            <div class="form-group">
                <label>Istruzioni</label>
                <textarea id="medInstructions" rows="2" placeholder="Istruzioni speciali..."></textarea>
            </div>
            <div class="button-row">
                <button id="medicationModalSaveBtn" class="btn btn-success" onclick="saveMedication()" data-testid="medication-modal-save-button">‚úÖ Aggiungi</button>
                <button class="btn btn-secondary" onclick="closeMedicationModal()" data-testid="medication-modal-cancel-button">‚ùå Annulla</button>
            </div>
        </div>
    </div>

    <!-- Modal: Fullscreen Textarea -->
    <div id="textareaFullscreen" class="modal">
        <div class="modal-content fullscreen-modal">
            <h3 id="fullscreenTitle" style="margin-bottom: 15px; text-align: center;">Testo</h3>
            <div class="fullscreen-buttons" style="margin-bottom: 15px;">
                <button id="btnSpeakFullscreen" class="btn btn-primary" onclick="speakFullscreenText()" data-testid="speak-fullscreen-button">üîä Leggi</button>
                <button id="btnCorrectFullscreen" class="btn btn-secondary" onclick="startFullscreenCorrection()" data-testid="correct-fullscreen-button">üé§ Correggi</button>
                <button class="btn btn-secondary" onclick="closeFullscreenTextarea()" data-testid="close-fullscreen-button">‚úï Chiudi</button>
            </div>
            <div id="fullscreenCorrectionButtons" class="correction-buttons" style="display: none; margin-bottom: 15px;">
                <button class="btn btn-danger" onclick="cancelFullscreenCorrection()" data-testid="cancel-fullscreen-correction-button">‚ùå Annulla</button>
                <button class="btn btn-success" onclick="sendFullscreenCorrection()" data-testid="send-fullscreen-correction-button">‚úÖ Invia correzione</button>
            </div>
            <textarea id="fullscreenTextarea" class="fullscreen-textarea"></textarea>
        </div>
    </div>
    
    <!-- Modal: Credit Exhausted -->
    <div id="creditExhaustedModal" class="modal">
        <div class="modal-content" style="text-align: center;">
            <h3 style="color: var(--error);">‚ö†Ô∏è Credito API Esaurito</h3>
            <p style="margin: 20px 0;">Il credito delle API OpenAI √® esaurito. Contatta l'amministratore per ricaricare il credito.</p>
            <button class="btn btn-primary" onclick="closeCreditExhaustedModal()" data-testid="close-credit-exhausted-button">OK, Ho capito</button>
        </div>
    </div>

    <!-- Modal: Change Password -->
    <div id="changePasswordModal" class="modal">
        <div class="modal-content">
            <h3>üîí Cambia Password</h3>
            <form onsubmit="event.preventDefault(); submitChangePassword();" autocomplete="on">
            <div class="form-group">
                <label>Password attuale</label>
                <input type="password" id="cpCurrentPassword" placeholder="Password attuale" autocomplete="current-password">
            </div>
            <div class="form-group">
                <label>Nuova password</label>
                <input type="password" id="cpNewPassword" placeholder="Nuova password (min. 6 caratteri)" autocomplete="new-password">
            </div>
            <div class="form-group">
                <label>Conferma nuova password</label>
                <input type="password" id="cpConfirmPassword" placeholder="Ripeti nuova password" autocomplete="new-password">
            </div>
            <p id="cpError" style="color:var(--error); font-size:13px; display:none; margin-bottom:10px;"></p>
            <div class="button-row">
                <button type="submit" class="btn btn-success" data-testid="submit-change-password-button">‚úÖ Cambia</button>
                <button type="button" class="btn btn-secondary" onclick="closeChangePasswordModal()" data-testid="cancel-change-password-button">‚ùå Annulla</button>
            </div>
            </form>
        </div>
    </div>

    <!-- Modal: Edit Pet -->
    <div id="editPetModal" class="modal">
        <div class="modal-content" style="max-width:600px;">
            <h3>‚úèÔ∏è Modifica Pet</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label>Nome Pet <span class="required">*</span></label>
                    <input type="text" id="editPetName" placeholder="Nome" required>
                </div>
                <div class="form-group">
                    <label>Specie <span class="required">*</span></label>
                    <select id="editPetSpecies" required>
                        <option value="">Seleziona...</option>
                        <option value="Cane">Cane</option>
                        <option value="Gatto">Gatto</option>
                        <option value="Coniglio">Coniglio</option>
                        <option value="Altro">Altro</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Razza</label>
                    <input type="text" id="editPetBreed" placeholder="Digita per cercare..." list="editPetBreedList" autocomplete="off">
                    <datalist id="editPetBreedList"></datalist>
                </div>
                <div class="form-group">
                    <label>Data di nascita</label>
                    <input type="date" id="editPetBirthdate">
                </div>
                <div class="form-group">
                    <label>Sesso</label>
                    <select id="editPetSex">
                        <option value="">Seleziona...</option>
                        <option value="Maschio">Maschio</option>
                        <option value="Maschio castrato">Maschio castrato</option>
                        <option value="Femmina">Femmina</option>
                        <option value="Femmina sterilizzata">Femmina sterilizzata</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Microchip</label>
                    <input type="text" id="editPetMicrochip" placeholder="N¬∞ Microchip">
                </div>
                <div class="form-group">
                    <label>Proprietario</label>
                    <select id="editOwnerName"><option value="">-- Seleziona proprietario --</option></select>
                </div>
                <div class="form-group">
                    <label>Vet Esterno (referral)</label>
                    <select id="editOwnerReferringVet"><option value="">‚Äî Nessuno ‚Äî</option></select>
                </div>
                <div class="form-group">
                    <label>Telefono</label>
                    <input type="tel" id="editOwnerPhone" placeholder="Telefono">
                </div>
                <div class="form-group">
                    <label>Data Visita</label>
                    <input type="date" id="editVisitDate">
                </div>
            </div>
            <button class="btn btn-secondary" style="margin-top: 20px; width: 100%;" onclick="toggleEditPetLifestyleSection()" data-testid="toggle-edit-pet-lifestyle-section-button">
                üè† Stile di Vita ‚ñº
            </button>
            <div id="editPetLifestyleSection" class="lifestyle-section">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Ambiente</label>
                        <select id="editPetLifestyle">
                            <option value="">Seleziona...</option>
                            <option value="indoor">Indoor</option>
                            <option value="outdoor">Outdoor</option>
                            <option value="misto">Misto</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Conviventi</label>
                        <select id="editPetHousehold" multiple>
                            <option value="bambini">Bambini</option>
                            <option value="anziani">Anziani</option>
                            <option value="altri_cani">Altri cani</option>
                            <option value="altri_gatti">Altri gatti</option>
                            <option value="altri_animali">Altri animali</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Livello di attivit√†</label>
                        <select id="editPetActivityLevel">
                            <option value="">Seleziona...</option>
                            <option value="basso">Basso</option>
                            <option value="medio">Medio</option>
                            <option value="alto">Alto</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Tipo alimentazione</label>
                        <select id="editPetDietType">
                            <option value="">Seleziona...</option>
                            <option value="secco">Secco</option>
                            <option value="umido">Umido</option>
                            <option value="barf">BARF</option>
                            <option value="misto">Misto</option>
                            <option value="casalingo">Casalingo</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Peso ideale (kg)</label>
                        <input type="number" id="editPetIdealWeight" step="0.1" placeholder="Peso target" min="0.1" max="200">
                    </div>
                    <div class="form-group">
                        <label>Pasti al giorno</label>
                        <select id="editPetMealsPerDay">
                            <option value="">Seleziona...</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4 (cuccioli)</option>
                        </select>
                    </div>
                    <div class="form-group full-width">
                        <label>Allergie alimentari</label>
                        <input type="text" id="editPetFoodAllergies" placeholder="Separare con virgola: pollo, mais, glutine...">
                    </div>
                    <div class="form-group full-width">
                        <label>Preferenze alimentari</label>
                        <input type="text" id="editPetDietPreferences" placeholder="Es: preferisce pollo, evita pesce...">
                    </div>
                    <div class="form-group full-width">
                        <label>Condizioni note</label>
                        <input type="text" id="editPetKnownConditions" placeholder="Es: insuff. renale, artrosi, allergie...">
                    </div>
                    <div class="form-group full-width">
                        <label>Farmaci attuali</label>
                        <input type="text" id="editPetCurrentMeds" placeholder="Farmaci in corso (opzionale)">
                    </div>
                    <div class="form-group full-width">
                        <label>Note comportamentali</label>
                        <input type="text" id="editPetBehaviorNotes" placeholder="Es: paure, ansia, aggressivit√†...">
                    </div>
                    <div class="form-group">
                        <label>Localit√† (opz.)</label>
                        <input type="text" id="editPetLocation" placeholder="Es: Milano">
                    </div>
                </div>
            </div>
            <div class="button-row" style="margin-top: 20px;">
                <button class="btn btn-success" onclick="saveEditPet()" data-testid="save-edit-pet-button">üíæ Salva</button>
                <button class="btn btn-danger" onclick="cancelEditPet()" data-testid="cancel-edit-pet-button">‚ùå Annulla</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast" data-testid="toast"></div>
    <div id="offlineBanner" class="offline-banner" style="display:none;">Modalita offline ‚Äî alcune funzionalita non sono disponibili</div>
    
    <!-- Progress Bar -->
    <div id="progressBar" class="progress-bar" data-testid="progress-bar"><div class="progress-fill"></div></div>

    <!-- Scripts -->
    <script>
      if (!window.ADA_API_BASE_URL && !["localhost", "127.0.0.1"].includes(window.location.hostname)) {
        //window.ADA_API_BASE_URL = "https://ada-au40.onrender.com";
		var isDevEnv = window.location.pathname.startsWith("/ada-dev");
        window.ADA_API_BASE_URL = isDevEnv
          ? "https://ada-backend-dev.onrender.com"
          : "https://ada-au40.onrender.com";
      }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.min.js"></script>
    <script src="config.js"></script>
    <script src="app-debug-logger.js"></script>
    <script src="app-loading.js"></script>
    <script src="app-openai-optimizations.js"></script>
    <script src="app-core.js"></script>
    <script src="app-recording.js"></script>
    <script src="app-soap.js"></script>
    <script src="app-tts.js"></script>
    <script src="app-data.js"></script>
    <script src="breed-data.js"></script>
    <script src="app-pets.js"></script>
    <script src="app-tips.js"></script>
    <script src="app-documents.js"></script>
    <script src="app-promo.js"></script>
    <script src="app-nutrition.js"></script>
    <script src="app-insurance.js"></script>
    <script src="app-communication.js"></script>
    <script src="app-webrtc.js"></script>
    <script src="app-ai-petdesc.js"></script>
    <script src="app-admin.js"></script>
    <script src="app-observability.js"></script>
    <script src="app-testdata.js"></script>
    <script src="app-seed.js"></script>
<script>
if ('serviceWorker' in navigator && !(/localhost|127\.0\.0\.1/).test(window.location.hostname)) {
    window.addEventListener('load', function() {
        navigator.serviceWorker.register('./sw.js')
            .catch(function() {});
    });
}
window.addEventListener('online', function() {
    var b = document.getElementById('offlineBanner');
    if (b) b.style.display = 'none';
    if (typeof showToast === 'function') showToast('Connessione ripristinata', 'success');
});
window.addEventListener('offline', function() {
    var b = document.getElementById('offlineBanner');
    if (b) b.style.display = '';
});
if (!navigator.onLine) {
    var b = document.getElementById('offlineBanner');
    if (b) b.style.display = '';
}
</script>
</body>
</html>